<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mood & Habits Tracker</title>

    <!-- Favicon and Fonts -->
    <link rel="icon" href="https://cdn-icons-png.flaticol.com/512/3448/3448338.png" type="image/png">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    
    <!-- Marked.js for Markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        /* Use the Inter font stack */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f9fafb; /* Lighter gray */
        }

        /* Custom styling for the range input slider */
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none;
            width: 24px; height: 24px;
            background: #4F46E5; /* Indigo */
            border-radius: 50%; cursor: grab;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            margin-top: -8px;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        input[type="range"]:active::-webkit-slider-thumb {
            cursor: grabbing; transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        input[type="range"]::-moz-range-thumb {
            width: 24px; height: 24px; background: #4F46E5;
            border-radius: 50%; cursor: grab; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        input[type="range"]::-webkit-slider-runnable-track {
            height: 8px; background: #E0E7FF; /* Indigo-100 */
            border-radius: 4px;
        }
        input[type="range"]::-moz-range-track {
            height: 8px; background: #E0E7FF; border-radius: 4px;
        }

        /* Styles for smooth modal transitions */
        .modal { transition: opacity 0.3s ease, visibility 0.3s ease; }
        .modal-content { transition: transform 0.3s ease; }

        /* Styles for collapsible sections */
        .collapsible-content {
            max-height: 0; overflow: hidden;
            transition: max-height 0.5s ease-in-out;
        }
        .collapsible-content.expanded { max-height: 1000px; } /* Increased max-height for potential content */

        /* Hide scrollbar but allow scrolling */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Calendar Styles */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, minmax(0, 1fr)); }
        .calendar-day {
            min-height: 120px;
            transition: background-color 0.3s;
        }
        .calendar-day-other-month { color: #9ca3af; } /* text-gray-400 */
        .calendar-day-today { border: 2px solid #4F46E5; } /* border-indigo-600 */
        
        /* Active nav link style */
        .nav-link.active {
            background-color: #4f46e5;
            color: white;
        }
        .nav-link {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: background-color 0.2s, color 0.2s;
        }
        .nav-link:not(.active):hover {
            background-color: #eef2ff;
        }

        /* Basic loading text animation */
        @keyframes blink {
            0% { opacity: 0.4; }
            50% { opacity: 1; }
            100% { opacity: 0.4; }
        }
        .loading-text {
            animation: blink 1.5s infinite;
        }

        /* Breath Helper specific styles */
        .breathing-circle-container {
            width: 250px; height: 250px;
            border-radius: 50%;
            background-color: #A5B4FC; /* Light indigo */
            display: flex; justify-content: center; align-items: center;
            transition: transform 4s ease-in-out; /* Default transition */
            margin: 2rem auto;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .breathing-circle-container.breathing-in {
            transform: scale(1.25);
            background-color: #4F46E5; /* Darker indigo */
            transition: transform var(--inhale-duration) ease-in-out;
        }

        .breathing-circle-container.breathing-hold {
            transform: scale(1.25);
            background-color: #4F46E5; /* Darker indigo */
            transition: transform var(--hold-duration) linear; /* No transform, just holding state */
        }

        .breathing-circle-container.breathing-out {
            transform: scale(1);
            background-color: #A5B4FC; /* Light indigo */
            transition: transform var(--exhale-duration) ease-in-out;
        }

        .breathing-text {
            font-size: 1.5rem;
            font-weight: 600;
            color: #ffffff;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body>

    <!-- Main Application Container -->
    <div id="app-container" class="w-full max-w-7xl mx-auto bg-white rounded-2xl shadow-xl my-4 md:my-8 p-4 sm:p-6 md:p-8 flex flex-col gap-6 opacity-0 transition-opacity duration-500">
        
        <div id="user-info" class="absolute top-2 right-4 text-xs text-gray-400">Loading...</div>

        <header class="flex flex-col sm:flex-row justify-between items-center gap-4 border-b border-gray-200 pb-6">
            <h1 class="text-2xl sm:text-3xl font-bold text-indigo-600">Zenith Tracker</h1>
            <nav class="flex flex-wrap justify-center gap-1 sm:gap-2">
                <button class="nav-link active" data-target="dashboard-section">Dashboard</button>
                <button class="nav-link" data-target="mood-logging-section">Log Mood</button>
                <button class="nav-link" data-target="journal-section">Journal</button> <!-- New Journal Nav Link -->
                <button class="nav-link" data-target="habit-tracking-section">Habits</button>
                <button class="nav-link" data-target="hydration-section">Hydration</button>
                <button class="nav-link" data-target="sleep-tracking-section">Sleep</button>
                <button class="nav-link" data-target="breath-helper-section">Breath</button>
                <button class="nav-link" data-target="calendar-section">Calendar</button>
                <button class="nav-link" data-target="analytics-section">Analytics</button>
                <button class="nav-link" data-target="recommendations-section">Recommendations</button>
                <button class="nav-link" data-target="utility-section">Utility</button>
            </nav>
        </header>

        <main>
            <div id="dashboard-section" class="content-section"></div>
            <div id="mood-logging-section" class="content-section hidden"></div>
            <div id="journal-section" class="content-section hidden"></div> <!-- New Journal Section -->
            <div id="habit-tracking-section" class="content-section hidden"></div>
            <div id="hydration-section" class="content-section hidden"></div>
            <div id="sleep-tracking-section" class="content-section hidden"></div>
            <div id="breath-helper-section" class="content-section hidden"></div>
            <div id="calendar-section" class="content-section hidden"></div>
            <div id="analytics-section" class="content-section hidden"></div>
            <div id="recommendations-section" class="content-section hidden"></div>
            <div id="utility-section" class="content-section hidden"></div>
        </main>
    </div>

    <!-- Modals (Habit & Confirmation) -->
    <div id="habit-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 invisible opacity-0">
        <div class="modal-content transform -translate-y-10 bg-white rounded-xl shadow-2xl w-full max-w-md p-6 overflow-y-auto max-h-[90vh]">
            <div class="flex justify-between items-center mb-4">
                <h2 id="habit-modal-title" class="text-xl font-bold">Add New Habit</h2>
                <button id="close-habit-modal" class="text-gray-400 hover:text-gray-600 text-3xl leading-none">&times;</button>
            </div>
            <div class="mb-4 text-right">
                <button type="button" id="suggest-habits-btn" class="px-3 py-1 bg-purple-600 text-white font-semibold rounded-md hover:bg-purple-700 text-sm flex items-center gap-1 inline-flex">âœ¨Suggest Habits</button>
            </div>
            <form id="habit-form" class="space-y-4">
                <input type="hidden" id="habit-id">
                <div>
                    <label for="new-habit-name" class="block text-sm font-medium text-gray-700">Habit Name</label>
                    <input type="text" id="new-habit-name" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g., Meditate for 10 minutes" required>
                </div>
                <div id="habit-suggestions-output" class="text-gray-600 text-sm mt-2 italic p-2 rounded-md border border-dashed border-gray-300 hidden"></div>
                <div>
                    <label for="habit-frequency" class="block text-sm font-medium text-gray-700">Frequency</label>
                    <select id="habit-frequency" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="daily">Daily</option>
                        <option value="specific-days">Specific Days</option>
                    </select>
                </div>
                <div id="specific-days-container" class="collapsible-content"><div class="flex flex-wrap gap-2"></div></div>
                <div class="flex gap-4">
                    <div class="flex-1">
                        <label for="habit-start-date" class="block text-sm font-medium text-gray-700">Start Date</label>
                        <input type="date" id="habit-start-date" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                    </div>
                    <div class="flex-1">
                        <label for="habit-end-date" class="block text-sm font-medium text-gray-700">End Date (Optional)</label>
                        <input type="date" id="habit-end-date" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                    </div>
                </div>
                <div>
                    <label for="habit-reminder-time" class="block text-sm font-medium text-gray-700">Reminder Time (Optional)</label>
                    <input type="time" id="habit-reminder-time" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                </div>
                <div class="border-t border-gray-200 pt-4 mt-4">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3">Habit Goal (Optional)</h3>
                    <div class="flex gap-2 mb-3">
                        <div class="flex-1">
                            <label for="habit-goal-type" class="block text-sm font-medium text-gray-700">Goal Type</label>
                            <select id="habit-goal-type" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                                <option value="">None</option>
                                <option value="count">Count (e.g., times completed)</option>
                                <option value="duration">Duration (e.g., total minutes)</option>
                            </select>
                        </div>
                        <div class="flex-1">
                            <label for="habit-goal-value" class="block text-sm font-medium text-gray-700">Target Value</label>
                            <input type="number" id="habit-goal-value" min="1" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" placeholder="e.g., 10">
                        </div>
                    </div>
                    <div>
                        <label for="habit-goal-unit" class="block text-sm font-medium text-gray-700">Unit (e.g., "books", "minutes", "times")</label>
                        <input type="text" id="habit-goal-unit" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" placeholder="e.g., pages, minutes, times">
                    </div>
                </div>
                <div>
                    <label for="habit-color-picker" class="block text-sm font-medium text-gray-700">Color</label>
                    <input type="color" id="habit-color-picker" value="#A5B4FC" class="mt-1 w-full h-10 border border-gray-300 rounded-md cursor-pointer">
                </div>
                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" id="cancel-habit-modal" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">Save Habit</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="confirm-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 invisible opacity-0">
        <div class="modal-content transform -translate-y-10 bg-white rounded-xl shadow-2xl w-full max-w-sm p-6 text-center">
            <h2 id="confirm-modal-title" class="text-xl font-bold mb-4">Are you sure?</h2>
            <p id="confirm-modal-text" class="text-gray-600 mb-6">This action cannot be undone.</p>
            <div class="flex justify-center gap-4">
                <button id="confirm-modal-cancel" class="px-6 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancel</button>
                <button id="confirm-modal-ok" class="px-6 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Delete</button>
            </div>
        </div>
    </div>

    <!-- Main Application Logic -->
    <script type="module">
        // --- App State & Local Storage Keys ---
        let moodLogs = [], habits = [], dailyHabitStatuses = {}, journalEntries = [];
        let sleepLogs = []; 
        let breathLogs = []; 
        let habitStreaks = {};
        let moodChartInstance = null, habitChartInstance = null, hydrationChartInstance = null, sleepChartInstance = null, breathChartInstance = null;
        let currentCalendarDate = new Date();
        let hasInitialDataLoaded = false;
        let hasResetBeenChecked = false;

        // Hydration specific state
        let dailyWaterNeed = 0; // in ml
        let dailyIntake = 0; // in ml

        // Breathing exercise state
        let breathingInterval = null;
        let currentPhase = 'initial'; // 'initial', 'inhale', 'hold', 'exhale'
        let inhaleDuration = 4; // seconds
        let holdDuration = 4; // seconds
        let exhaleDuration = 4; // seconds
        let phaseTimeoutId = null;
        let sessionStartTime = null;

        // Local Storage Keys
        const LS_MOOD_LOGS = 'zenithTrackerMoodLogs';
        const LS_HABITS = 'zenithTrackerHabits';
        const LS_HABIT_STATUSES = 'zenithTrackerHabitStatuses';
        const LS_METADATA = 'zenithTrackerMetadata';
        const LS_HYDRATION_LOGS = 'zenithTrackerHydrationLogs';
        const LS_NOTIFICATIONS_SENT = 'zenithTrackerNotificationsSent';
        const LS_SLEEP_LOGS = 'zenithTrackerSleepLogs'; 
        const LS_BREATH_LOGS = 'zenithTrackerBreathLogs';
        const LS_JOURNAL_ENTRIES = 'zenithTrackerJournalEntries';

        // --- UI Element References ---
        const appContainer = document.getElementById('app-container');
        const userInfo = document.getElementById('user-info');
        const habitModal = document.getElementById('habit-modal');
        const confirmModal = document.getElementById('confirm-modal');
        const moodInsightOutput = document.createElement('div'); 
        moodInsightOutput.id = 'mood-insight-output';
        moodInsightOutput.className = 'bg-blue-100 text-blue-800 p-3 rounded-md mt-4 hidden';

        const habitSuggestionsOutput = document.getElementById('habit-suggestions-output'); 
        const sleepAnalysisOutput = document.createElement('div'); 
        sleepAnalysisOutput.id = 'sleep-analysis-output';
        sleepAnalysisOutput.className = 'bg-blue-100 text-blue-800 p-3 rounded-md mt-4 hidden';
        
        const journalPromptOutput = document.createElement('div');
        journalPromptOutput.id = 'journal-prompt-output';
        journalPromptOutput.className = 'bg-green-100 text-green-800 p-3 rounded-md mt-4 hidden';


        // --- Helper Functions ---
        const hexToRgb = (hex = '#ffffff') => {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? [parseInt(result[1], 16), parseInt(result[2], 16), parseInt(result[3], 16)] : [255, 255, 255];
        };
        const getTextColorForBackground = (hexColor) => {
            const [r, g, b] = hexToRgb(hexColor);
            return (0.299 * r + 0.587 * g + 0.114 * b) / 255 > 0.5 ? 'text-gray-800' : 'text-white';
        };
        const formatDateTime = (date) => new Date(date)?.toLocaleString('en-US', { month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' }) || 'Invalid Date';
        const toYYYYMMDD = (date) => {
            const d = new Date(date);
            if (isNaN(d.getTime())) return null;
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };
        const generateUniqueId = () => '_' + Math.random().toString(36).substr(2, 9); 

        // Beverage conversion factors (water equivalent per 1ml)
        const BEVERAGE_WATER_EQUIVALENT = {
            'water': 1.0, 'tea': 1.0, 'coffee': 0.8, 'cold-drinks': 0.5, 'juice': 0.8 
        };

        const DRINK_COLORS = {
            'water': '#4F46E5', 'tea': '#10B981', 'coffee': '#EAB308', 'cold-drinks': '#EF4444', 'juice': '#F97316', 'remaining': '#E0E7FF' 
        };

        let notificationsSentToday = {}; 
        let hydrationLogs = {}; 
        
        // --- Gemini API Integrations ---
        async function callGeminiAPI(prompt, config = {}) {
            const apiKey = "AIzaSyB1_pV6pkD1ohLBe18ey0gy6Pz4BRXD8Dg"; // API Key is managed by the environment
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ role: "user", parts: [{ text: prompt }] }],
                ...config
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorBody = await response.text();
                    console.error("API Error Response:", errorBody);
                    throw new Error(`API request failed with status ${response.status}`);
                }

                const result = await response.json();
                if (result.candidates && result.candidates[0]?.content?.parts[0]?.text) {
                    return result.candidates[0].content.parts[0].text;
                } else {
                    console.error("Unexpected API response structure:", result);
                    throw new Error("Could not parse valid content from API response.");
                }
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                throw error;
            }
        }
        
        // --- Local Storage Operations ---
        const loadData = () => {
            try {
                moodLogs = JSON.parse(localStorage.getItem(LS_MOOD_LOGS) || '[]').map(log => ({ ...log, timestamp: new Date(log.timestamp) }));
                habits = JSON.parse(localStorage.getItem(LS_HABITS) || '[]').map(habit => ({ ...habit, createdAt: new Date(habit.createdAt) }));
                dailyHabitStatuses = JSON.parse(localStorage.getItem(LS_HABIT_STATUSES) || '{}');
                sleepLogs = JSON.parse(localStorage.getItem(LS_SLEEP_LOGS) || '[]').map(log => ({ ...log, date: new Date(log.date) }));
                breathLogs = JSON.parse(localStorage.getItem(LS_BREATH_LOGS) || '[]').map(log => ({ ...log, timestamp: new Date(log.timestamp) }));
                hydrationLogs = JSON.parse(localStorage.getItem(LS_HYDRATION_LOGS) || '{}');
                journalEntries = JSON.parse(localStorage.getItem(LS_JOURNAL_ENTRIES) || '[]').map(entry => ({...entry, date: new Date(entry.date) }));


                const metadata = JSON.parse(localStorage.getItem(LS_METADATA) || '{}');
                dailyWaterNeed = metadata.dailyWaterNeed || 0;
                
                const todayKey = toYYYYMMDD(new Date());
                dailyIntake = hydrationLogs[todayKey] ? hydrationLogs[todayKey].totalIntake : 0;

            } catch (e) {
                console.error("Local Storage: Error loading data. Resetting data to prevent crashes.", e);
                localStorage.clear();
                moodLogs = []; habits = []; dailyHabitStatuses = {}; dailyWaterNeed = 0; dailyIntake = 0;
                hydrationLogs = {}; sleepLogs = []; breathLogs = []; journalEntries = [];
            }
        };

        const saveData = () => {
            try {
                localStorage.setItem(LS_MOOD_LOGS, JSON.stringify(moodLogs));
                localStorage.setItem(LS_HABITS, JSON.stringify(habits));
                localStorage.setItem(LS_HABIT_STATUSES, JSON.stringify(dailyHabitStatuses));
                localStorage.setItem(LS_METADATA, JSON.stringify({ dailyWaterNeed, lastReset: JSON.parse(localStorage.getItem(LS_METADATA) || '{}').lastReset }));
                localStorage.setItem(LS_SLEEP_LOGS, JSON.stringify(sleepLogs)); 
                localStorage.setItem(LS_BREATH_LOGS, JSON.stringify(breathLogs)); 
                localStorage.setItem(LS_HYDRATION_LOGS, JSON.stringify(hydrationLogs));
                localStorage.setItem(LS_JOURNAL_ENTRIES, JSON.stringify(journalEntries));
                saveNotificationsSent();
            } catch (e) {
                console.error("Local Storage: Error saving data.", e);
            }
        };

        const loadNotificationsSent = () => {
            const todayKey = toYYYYMMDD(new Date());
            const stored = JSON.parse(localStorage.getItem(LS_NOTIFICATIONS_SENT) || '{}');
            notificationsSentToday = stored[todayKey] || {};
        };

        const saveNotificationsSent = () => {
            const todayKey = toYYYYMMDD(new Date());
            const allNotifications = JSON.parse(localStorage.getItem(LS_NOTIFICATIONS_SENT) || '{}');
            allNotifications[todayKey] = notificationsSentToday;
            localStorage.setItem(LS_NOTIFICATIONS_SENT, JSON.stringify(allNotifications));
        };
        
        // --- Modals and Navigation ---
        const toggleModal = (modal, show) => {
            const content = modal.querySelector('.modal-content');
            if (show) {
                modal.classList.remove('invisible', 'opacity-0');
                content.classList.remove('-translate-y-10');
            } else {
                modal.classList.add('opacity-0');
                content.classList.add('-translate-y-10');
                setTimeout(() => modal.classList.add('invisible'), 300);
            }
        };
        
        let confirmCallback = null;
        let cancelCallback = null;
        const showConfirmation = (title, text, onConfirm, onCancel = () => {}, okButtonText = 'Confirm', okButtonColor = 'bg-red-600') => { 
            document.getElementById('confirm-modal-title').textContent = title;
            document.getElementById('confirm-modal-text').textContent = text;
            confirmCallback = onConfirm;
            cancelCallback = onCancel;

            const okButton = document.getElementById('confirm-modal-ok');
            okButton.textContent = okButtonText;
            okButton.className = okButton.className.split(' ').filter(cls => !cls.startsWith('bg-')).join(' ');
            okButton.classList.add(okButtonColor, `hover:${okButtonColor.replace('600', '700')}`);

            toggleModal(confirmModal, true);
        };
        
        const showSection = (targetId) => {
            document.querySelectorAll('.content-section').forEach(s => s.classList.add('hidden'));
            const section = document.getElementById(targetId);
            if(section) section.classList.remove('hidden');
            document.querySelectorAll('.nav-link').forEach(l => l.classList.toggle('active', l.dataset.target === targetId));
            
            if (targetId !== 'breath-helper-section') { 
                stopBreathing(false);
            }
            renderContentForSection(targetId); 
        };
        
        const renderContentForSection = (sectionId) => {
            const section = document.getElementById(sectionId);
            if (!section) return;
            if (section.renderTimeout) clearTimeout(section.renderTimeout);
            section.renderTimeout = setTimeout(() => {
                if (!hasInitialDataLoaded) return;
                switch (sectionId) {
                    case 'dashboard-section': section.innerHTML = renderDashboard(); break;
                    case 'mood-logging-section': section.innerHTML = renderMoodLoggingPage(); break;
                    case 'journal-section': section.innerHTML = renderJournalPage(); break;
                    case 'habit-tracking-section': section.innerHTML = renderHabitTrackingPage(); break;
                    case 'hydration-section': 
                        section.innerHTML = renderHydrationPage();
                        updateHydrationChart(); 
                        break;
                    case 'sleep-tracking-section': 
                        section.innerHTML = renderSleepTrackingPage(); 
                        break; 
                    case 'breath-helper-section':
                        section.innerHTML = renderBreathHelperPage();
                        document.getElementById('inhale-duration-input').value = inhaleDuration;
                        document.getElementById('hold-duration-input').value = holdDuration;
                        document.getElementById('exhale-duration-input').value = exhaleDuration;
                        break;
                    case 'calendar-section': section.innerHTML = renderCalendarView(currentCalendarDate); break;
                    case 'analytics-section': 
                        section.innerHTML = renderAnalyticsPage();
                        renderSummaryStatistics('7days');
                        renderMoodTrendChart('7days');
                        renderHabitCompletionChart('7days');
                        renderSleepTrendChart('7days');
                        renderHydrationTrendChart('7days');
                        renderBreathTrendChart('7days');
                        break;
                    case 'recommendations-section':
                        section.innerHTML = renderRecommendationsPage();
                        generatePersonalizedRecommendations('7days'); 
                        break;
                    case 'utility-section': section.innerHTML = renderUtilityPage(); break;
                }
            }, 50);
        };
        
        // --- HTML Template Renderers ---
        const SVG_ICONS = {
            plus: `<svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>`,
            edit: `<svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>`,
            trash: `<svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>`,
            fire: `<svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.373 2.144a.75.75 0 00-1.292-.884l-2.322 3.318a.75.75 0 00.53 1.226H11l-2.43 3.645a.75.75 0 00.999 1.058l5-2.5a.75.75 0 00-.03-1.393l-2.17-1.085 2-2.857a.75.75 0 00-.5-1.071L13.5 2.5l-1.127-.356zM8.25 11.25a.75.75 0 01.75.75v5.033a.75.75 0 01-1.5 0V12a.75.75 0 01.75-.75z" clip-rule="evenodd" /><path d="M5.21 9.24a.75.75 0 01.22-.53l3.38-4.83a.75.75 0 011.38.15l-1.57 5.48a.75.75 0 01-1.45.03L5.43 9.77a.75.75 0 01-.22-.53zm-1.04 4.01a.75.75 0 01.03-1.06l1.32-1.32a.75.75 0 111.06 1.06l-1.32 1.32a.75.75 0 01-1.06-.03z" /></svg>`,
            archive: `<svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h3" /></svg>`,
            unarchive: `<svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>`,
            copy: `<svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M7 3a1 1 0 000 2h6a1 1 0 100-2H7zM4 7a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1zM5 11a1 1 0 100 2h4a1 1 0 100-2H5z" /></svg>`
        };
        const MOOD_EMOJIS = ['ðŸ˜¡', 'ðŸ˜ ', 'ðŸ˜ž', 'ðŸ˜”', 'ðŸ˜', 'ðŸ™‚', 'ðŸ˜Š', 'ðŸ˜„', 'ðŸ˜', 'ðŸ¤©'];
        const getMoodColor = (level) => `hsl(${(level - 1) * 12 + 5}, 80%, 60%)`;

        function renderDashboard() {
            const today = new Date();
            const sevenDaysAgo = new Date(today);
            sevenDaysAgo.setDate(today.getDate() - 6);
            const recentMoods = moodLogs.filter(log => new Date(log.timestamp) >= sevenDaysAgo);
            const avgMood = recentMoods.length ? (recentMoods.reduce((sum, log) => sum + log.moodLevel, 0) / recentMoods.length).toFixed(1) : '--';
            
            let dueCount = 0, completedCount = 0;
            habits.filter(h => !h.isArchived).forEach(habit => {
                if(isHabitDueOn(habit, today)) {
                    dueCount++;
                    if(getHabitStatusOnDate(habit.id, toYYYYMMDD(today)) === 'completed') completedCount++;
                }
            });

            return `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-indigo-100 p-6 rounded-xl text-center">
                        <h3 class="text-xl font-semibold text-gray-700 mb-2">Last 7 Days Mood</h3>
                        <p class="text-5xl font-extrabold text-indigo-700">${avgMood}</p>
                    </div>
                     <div class="bg-green-100 p-6 rounded-xl text-center">
                        <h3 class="text-xl font-semibold text-gray-700 mb-2">Today's Habits</h3>
                        <p class="text-4xl font-extrabold"><span class="text-green-600">${completedCount}</span> / <span class="text-gray-800">${dueCount}</span></p>
                    </div>
                </div>
                <div class="mt-8"><h3 class="text-2xl font-bold text-gray-800 mb-4">Today's Habits</h3><div id="daily-habits-container" class="space-y-3">${renderDailyHabitsList()}</div></div>
                <div class="mt-8"><h3 class="text-2xl font-bold text-gray-800 mb-4">Recent Mood Logs</h3><div id="recent-moods-container" class="space-y-3">${renderMoodLogsList(5)}</div></div>
            `;
        }

        function renderMoodLoggingPage() {
            moodInsightOutput.innerHTML = '';
            moodInsightOutput.classList.add('hidden');
            journalPromptOutput.innerHTML = '';
            journalPromptOutput.classList.add('hidden');

            return `
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-gray-50 p-6 rounded-xl">
                        <h2 class="text-2xl font-bold mb-6">How are you feeling?</h2>
                        <div class="space-y-6">
                            <div>
                                <label for="mood-slider" class="block text-lg font-medium text-center">
                                    Overall Mood: <span id="mood-value" class="text-indigo-600 font-semibold">5</span>
                                    <span id="mood-emoji" class="text-5xl block mt-2">${MOOD_EMOJIS[4]}</span>
                                </label>
                                <input type="range" id="mood-slider" min="1" max="10" value="5" class="w-full mt-4">
                            </div>
                            <div>
                                <label for="mood-notes" class="block text-sm font-medium text-gray-700">Journal Entry</label>
                                <textarea id="mood-notes" rows="4" class="mt-1 block w-full border border-gray-300 rounded-md p-2" placeholder="What's on your mind?"></textarea>
                            </div>
                            <div class="flex justify-end">
                                <button type="button" id="get-journal-prompt-btn" class="px-3 py-1 bg-green-600 text-white font-semibold rounded-md hover:bg-green-700 text-sm flex items-center gap-1">âœ¨Get Prompt</button>
                            </div>
                            <div id="journal-prompt-container"></div>
                            <div>
                                <label for="mood-tags" class="block text-sm font-medium text-gray-700">Tags (comma-separated)</label>
                                <input type="text" id="mood-tags" class="mt-1 block w-full border border-gray-300 rounded-md p-2" placeholder="e.g., work, stress, family, joy">
                            </div>

                            <button id="log-mood-btn" class="w-full bg-indigo-600 text-white font-semibold py-3 rounded-lg hover:bg-indigo-700">Log Mood</button>
                            <button id="get-mood-insight-btn" class="w-full bg-blue-600 text-white font-semibold py-3 rounded-lg hover:bg-blue-700 mt-2">âœ¨Get Journal Insight</button>
                            <div id="mood-insight-container"></div>
                        </div>
                    </div>
                    <div><h2 class="text-2xl font-bold mb-6">Mood History</h2><div id="mood-log-list-full" class="space-y-3 max-h-[60vh] overflow-y-auto no-scrollbar">${renderMoodLogsList()}</div></div>
                </div>`;
        }
        
        function renderMoodLogsList(limit = 0) {
            if (moodLogs.length === 0) return `<p class="text-gray-500 text-center py-4">No moods logged yet.</p>`;
            const sortedMoods = [...moodLogs].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            const toRender = limit > 0 ? sortedMoods.slice(0, limit) : sortedMoods;
            return toRender.map(log => {
                const moodColor = getMoodColor(log.moodLevel);
                return `
                    <div class="p-4 rounded-lg flex items-center gap-4 ${getTextColorForBackground(moodColor)}" style="background-color: ${moodColor};">
                        <span class="text-4xl">${MOOD_EMOJIS[log.moodLevel - 1]}</span>
                        <div class="flex-grow">
                            <p class="font-bold">Mood: ${log.moodLevel}/10</p>
                            <p class="text-sm opacity-90">${formatDateTime(log.timestamp)}</p>
                            ${log.notes ? `<p class="text-sm mt-1 italic">"${log.notes}"</p>` : ''}
                            ${log.tags && log.tags.length > 0 ? `<p class="text-xs mt-1 opacity-80">Tags: ${log.tags.join(', ')}</p>` : ''}
                        </div>
                        <button class="delete-mood-btn p-2 hover:bg-black/20 rounded-full" data-id="${log.id}">${SVG_ICONS.trash}</button>
                    </div>`;
            }).join('');
        }

        function renderHabitTrackingPage() {
            const showArchived = localStorage.getItem('showArchivedHabits') === 'true';
            const filteredHabits = habits.filter(h => showArchived ? true : !h.isArchived);

            return `
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">Your Habits</h2>
                    <div class="flex items-center gap-3">
                        <label class="inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="toggle-archived-habits" class="form-checkbox text-indigo-600" ${showArchived ? 'checked' : ''}>
                            <span class="ml-2 text-gray-700 text-sm">Show Archived</span>
                        </label>
                        <button id="add-new-habit-btn" class="flex items-center gap-2 bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700">
                            ${SVG_ICONS.plus}<span>Add Habit</span>
                        </button>
                    </div>
                </div>
                <div id="habits-list-container" class="space-y-4">${renderHabitsList(filteredHabits)}</div>`;
        }

        function renderHabitsList(habitsToRender) {
            if(habitsToRender.length === 0) return `<p class="text-gray-500 text-center py-8">No habits yet. Click 'Add Habit' to start!'</p>`;
            const sortedHabits = [...habitsToRender].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            return sortedHabits.map(habit => {
                const goalInfo = habit.goalType && habit.goalValue ? `Goal: ${habit.goalValue} ${habit.goalUnit || habit.goalType}` : '';
                return `
                    <div class="rounded-lg p-4 flex items-center gap-4 ${getTextColorForBackground(habit.color)}" style="background-color: ${habit.color};">
                        <div class="flex-grow">
                            <p class="font-bold text-lg">${habit.name} ${habit.isArchived ? '<span class="text-sm italic opacity-80">(Archived)</span>' : ''}</p>
                            <p class="text-sm opacity-90">${habit.frequency === 'daily' ? 'Daily' : `On: ${habit.days.join(', ')}`}</p>
                            ${habit.habitReminderTime ? `<p class="text-xs opacity-80">Reminder: ${habit.habitReminderTime}</p>` : ''}
                            ${goalInfo ? `<p class="text-xs opacity-80">${goalInfo}</p>` : ''}
                        </div>
                        <div class="flex items-center gap-2 font-bold" title="Current Streak">
                            ${SVG_ICONS.fire} <span>${habitStreaks[habit.id] || 0}</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <button class="edit-habit-btn p-2 rounded-full hover:bg-black/20" data-id="${habit.id}">${SVG_ICONS.edit}</button>
                            <button class="archive-toggle-habit-btn p-2 rounded-full hover:bg-black/20" data-id="${habit.id}" data-archived="${habit.isArchived ? 'true' : 'false'}" title="${habit.isArchived ? 'Unarchive' : 'Archive'}">
                                ${habit.isArchived ? SVG_ICONS.unarchive : SVG_ICONS.archive}
                            </button>
                            <button class="delete-habit-btn p-2 rounded-full hover:bg-black/20" data-id="${habit.id}">${SVG_ICONS.trash}</button>
                        </div>
                    </div>`;
            }).join('');
        }
        
        function renderDailyHabitsList() {
            const today = new Date();
            const habitsDue = habits.filter(h => !h.isArchived && isHabitDueOn(h, today));
            if(habitsDue.length === 0) return `<p class="text-gray-500 text-center py-4">No habits due today.</p>`;
            return habitsDue.map(habit => {
                const status = getHabitStatusOnDate(habit.id, toYYYYMMDD(today));
                return `
                    <div class="p-3 rounded-lg flex items-center gap-4 border border-gray-200">
                        <div class="w-3 h-3 rounded-full" style="background-color:${habit.color};"></div>
                        <p class="flex-grow font-semibold">${habit.name}</p>
                        <div class="flex gap-1">
                            <button class="habit-status-btn px-3 py-1 text-sm rounded-md ${status === 'completed' ? 'bg-green-500 text-white' : 'bg-gray-200'}" data-habit-id="${habit.id}" data-status="completed">Done</button>
                            <button class="habit-status-btn px-3 py-1 text-sm rounded-md ${status === 'skipped' ? 'bg-yellow-500 text-white' : 'bg-gray-200'}" data-habit-id="${habit.id}" data-status="skipped">Skip</button>
                        </div>
                    </div>`;
            }).join('');
        }

        function renderHydrationPage() {
            const percentage = dailyWaterNeed > 0 ? Math.min(100, (dailyIntake / dailyWaterNeed) * 100) : 0;
            const statusColor = percentage >= 100 ? 'text-green-600' : 'text-orange-500';

            return `
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-gray-50 p-6 rounded-xl">
                        <h2 class="text-2xl font-bold mb-6">Calculate Daily Water Need</h2>
                        <form id="water-need-form" class="space-y-4">
                            <div>
                                <label for="user-age" class="block text-sm font-medium text-gray-700">Age (years)</label>
                                <input type="number" id="user-age" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" placeholder="e.g., 30" min="1" max="120">
                            </div>
                            <div>
                                <label for="user-weight" class="block text-sm font-medium text-gray-700">Weight (kg)</label>
                                <input type="number" id="user-weight" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" placeholder="e.g., 70" min="10" max="300">
                            </div>
                            <div>
                                <label for="activity-level" class="block text-sm font-medium text-gray-700">Activity Level</label>
                                <select id="activity-level" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                                    <option value="sedentary">Sedentary</option>
                                    <option value="lightly_active">Lightly Active</option>
                                    <option value="moderately_active">Moderately Active</option>
                                    <option value="very_active">Very Active</option>
                                    <option value="extra_active">Extra Active</option>
                                </select>
                            </div>
                            <div>
                                <label for="climate" class="block text-sm font-medium text-gray-700">Climate</label>
                                <select id="climate" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                                    <option value="temperate">Temperate</option>
                                    <option value="hot_humid">Hot & Humid</option>
                                    <option value="hot_dry">Hot & Dry</option>
                                    <option value="cold">Cold</option>
                                </select>
                            </div>
                            <button type="button" id="calculate-water-need-btn" class="w-full bg-indigo-600 text-white font-semibold py-3 rounded-lg hover:bg-indigo-700">Calculate My Water Need</button>
                            <div id="water-need-output" class="bg-blue-100 text-blue-800 p-3 rounded-md mt-4 hidden"></div>
                        </form>
                    </div>

                    <div class="bg-gray-50 p-6 rounded-xl">
                        <h2 class="text-2xl font-bold mb-6">Today's Hydration</h2>
                        <div class="text-center mb-6">
                            <p class="text-xl font-semibold text-gray-700">Daily Goal: <span id="display-water-need" class="text-indigo-600">${dailyWaterNeed} ml</span></p>
                            <p class="text-sm text-gray-500 italic mb-2">AI-generated estimate. Consult a professional for personalized advice.</p>
                            <p class="text-xl font-semibold text-gray-700">Current Intake: <span id="display-current-intake" class="text-green-600">${dailyIntake.toFixed(0)} ml</span></p>
                            <p class="text-lg font-semibold ${statusColor}" id="hydration-percentage-text">${percentage.toFixed(0)}% fulfilled</p>
                        </div>
                        <div class="relative h-64 w-64 mx-auto mb-6">
                            <canvas id="hydration-chart"></canvas>
                        </div>
                        <div class="space-y-4">
                            ${Object.keys(BEVERAGE_WATER_EQUIVALENT).map(type => `
                                <div class="flex items-center gap-2">
                                    <label for="log-${type}-qty" class="capitalize flex-grow text-sm font-medium text-gray-700">${type.replace('-', ' ')} (ml)</label>
                                    <input type="number" id="log-${type}-qty" class="w-24 border border-gray-300 rounded-md shadow-sm p-2" value="250" min="1">
                                    <button class="log-drink-btn px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600" data-drink-type="${type}">Log</button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderSleepTrackingPage() {
            return `
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-gray-50 p-6 rounded-xl">
                        <h2 class="text-2xl font-bold mb-6">Log Your Sleep</h2>
                        <div class="space-y-6">
                            <div>
                                <label for="sleep-date" class="block text-sm font-medium text-gray-700">Date</label>
                                <input type="date" id="sleep-date" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" value="${toYYYYMMDD(new Date())}">
                            </div>
                            <div class="flex gap-4">
                                <div class="flex-1">
                                    <label for="sleep-hours" class="block text-sm font-medium text-gray-700">Hours</label>
                                    <input type="number" id="sleep-hours" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" min="0" max="24" value="8">
                                </div>
                                <div class="flex-1">
                                    <label for="sleep-minutes" class="block text-sm font-medium text-gray-700">Minutes</label>
                                    <input type="number" id="sleep-minutes" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" min="0" max="59" value="0">
                                </div>
                            </div>
                            <div>
                                <label for="sleep-quality-slider" class="block text-sm font-medium text-gray-700">Sleep Quality: <span id="sleep-quality-value" class="font-semibold text-indigo-600">3</span>/5</label>
                                <input type="range" id="sleep-quality-slider" min="1" max="5" value="3" class="w-full mt-1">
                            </div>
                            <div>
                                <label for="sleep-abnormalities" class="block text-sm font-medium text-gray-700">Sleep Abnormalities / Notes</label>
                                <textarea id="sleep-abnormalities" rows="4" class="mt-1 block w-full border border-gray-300 rounded-md p-2" placeholder="e.g., Woke up twice, had vivid dreams"></textarea>
                            </div>
                            <button id="log-sleep-btn" class="w-full bg-indigo-600 text-white font-semibold py-3 rounded-lg hover:bg-indigo-700">Log Sleep</button>
                            <div id="sleep-logging-status" class="bg-blue-100 text-blue-800 p-3 rounded-md mt-4 hidden"></div>
                        </div>
                    </div>
                    <div><h2 class="text-2xl font-bold mb-6">Sleep History</h2><div id="sleep-log-list" class="space-y-3 max-h-[60vh] overflow-y-auto no-scrollbar">${renderSleepLogsList()}</div></div>
                </div>`;
        }

        function renderSleepLogsList() {
            if (sleepLogs.length === 0) return `<p class="text-gray-500 text-center py-4">No sleep logs yet.</p>`;
            const sortedSleeps = [...sleepLogs].sort((a, b) => new Date(b.date) - new Date(a.date));
            return sortedSleeps.map(log => `
                <div class="p-4 rounded-lg bg-white shadow-sm border border-gray-200">
                    <div class="flex justify-between items-center mb-2">
                        <p class="font-bold text-lg">${toYYYYMMDD(log.date)}</p>
                        <button class="delete-sleep-log-btn text-gray-400 hover:text-gray-600" data-id="${log.id}">${SVG_ICONS.trash}</button>
                    </div>
                    <p class="text-gray-700">Duration: ${log.duration} hours</p>
                    <p class="text-gray-700">Quality: ${log.sleepQuality || 'N/A'}/5 Stars</p>
                    ${log.abnormalities ? `<p class="text-sm italic text-gray-600 mt-1">Notes: "${log.abnormalities}"</p>` : ''}
                    ${log.analysis && log.analysis !== 'Analysis failed.' && log.analysis !== 'Error during analysis.' ? `<div class="bg-blue-50 text-blue-800 p-2 text-sm rounded-md mt-2"><strong>AI Analysis:</strong> ${marked.parse(log.analysis)}</div>` : ''}
                    ${log.analysis === null && log.abnormalities ? `<div id="sleep-analysis-loading-${log.id}" class="bg-yellow-100 text-yellow-800 p-2 text-sm rounded-md mt-2 loading-text">Generating analysis...</div>` : ''}
                </div>`).join('');
        }


        function renderBreathHelperPage() {
            return `
                <div class="flex flex-col items-center justify-center p-6 bg-gray-50 rounded-xl max-w-lg mx-auto shadow-md">
                    <h2 class="text-2xl font-bold text-center mb-6">Guided Breathing</h2>
                    <div id="breathing-circle" class="breathing-circle-container">
                        <span id="breathing-text" class="breathing-text">Start</span>
                    </div>
                    <div class="flex flex-wrap justify-center gap-4 mt-6 w-full">
                        <div class="flex-1 min-w-[100px] max-w-[150px]">
                            <label for="inhale-duration-input" class="block text-sm font-medium text-gray-700">Inhale (s)</label>
                            <input type="number" id="inhale-duration-input" min="1" value="4" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-center">
                        </div>
                        <div class="flex-1 min-w-[100px] max-w-[150px]">
                            <label for="hold-duration-input" class="block text-sm font-medium text-gray-700">Hold (s)</label>
                            <input type="number" id="hold-duration-input" min="0" value="4" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-center">
                        </div>
                        <div class="flex-1 min-w-[100px] max-w-[150px]">
                            <label for="exhale-duration-input" class="block text-sm font-medium text-gray-700">Exhale (s)</label>
                            <input type="number" id="exhale-duration-input" min="1" value="4" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-center">
                        </div>
                    </div>
                    <div class="mt-6 flex gap-4">
                        <button id="start-breathing-btn" class="px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700">Start Breathing</button>
                        <button id="stop-breathing-btn" class="px-6 py-3 bg-red-500 text-white font-semibold rounded-lg hover:bg-red-600">Stop</button>
                    </div>
                    <div class="mt-8 w-full">
                        <h3 class="text-xl font-semibold mb-4 text-gray-800 text-center">Breathing Session History</h3>
                        <div id="breathing-log-list" class="space-y-3 max-h-[40vh] overflow-y-auto no-scrollbar">
                            ${renderBreathLogsList()}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderBreathLogsList() {
            if (breathLogs.length === 0) return `<p class="text-gray-500 text-center py-4">No breathing sessions logged yet.</p>`;
            const sortedLogs = [...breathLogs].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            return sortedLogs.map(log => `
                <div class="p-3 rounded-lg bg-white shadow-sm border border-gray-200 flex justify-between items-center">
                    <div>
                        <p class="font-semibold">${formatDateTime(log.timestamp)}</p>
                        <p class="text-sm text-gray-600">Pattern: ${log.inhaleDuration}s Inhale, ${log.holdDuration}s Hold, ${log.exhaleDuration}s Exhale</p>
                        <p class="text-sm text-gray-600">Duration: ${(log.elapsedTime / 60).toFixed(1)} minutes</p>
                    </div>
                    <button class="delete-breath-log-btn text-gray-400 hover:text-gray-600" data-id="${log.id}">${SVG_ICONS.trash}</button>
                </div>
            `).join('');
        }

        function renderCalendarView(date) {
            const month = date.getMonth(), year = date.getFullYear();
            const firstDayOfMonth = new Date(year, month, 1);
            const lastDayOfMonth = new Date(year, month + 1, 0);
            
            let dayCells = Array(firstDayOfMonth.getDay()).fill('<div class="calendar-day border border-gray-200 bg-gray-50"></div>').join('');

            for (let i = 1; i <= lastDayOfMonth.getDate(); i++) {
                const dayDate = new Date(year, month, i);
                const dateKey = toYYYYMMDD(dayDate);
                
                const moodsToday = moodLogs.filter(log => toYYYYMMDD(new Date(log.timestamp)) === dateKey);
                const avgMood = moodsToday.length ? moodsToday.reduce((s, l) => s + l.moodLevel, 0) / moodsToday.length : null;
                
                const habitDots = habits.filter(h => !h.isArchived && dailyHabitStatuses[h.id]?.[dateKey] === 'completed')
                                        .map(h => `<div class="w-2 h-2 rounded-full" style="background-color:${h.color}" title="${h.name}"></div>`)
                                        .join('');
                
                const moodIndicator = avgMood ? `<span class="text-2xl" title="Avg Mood: ${avgMood.toFixed(1)}">${MOOD_EMOJIS[Math.round(avgMood) - 1]}</span>` : '';
                const moodColor = avgMood ? getMoodColor(avgMood) : 'transparent';
                const textColor = avgMood ? getTextColorForBackground(moodColor) : '';
                
                dayCells += `
                    <div class="calendar-day border border-gray-200 p-2 ${toYYYYMMDD(new Date()) === dateKey ? 'calendar-day-today' : ''}" style="background-color: ${moodColor};">
                        <div class="flex justify-between items-start">
                            <div class="font-semibold ${textColor}">${i}</div>
                            ${moodIndicator}
                        </div>
                        <div class="flex flex-wrap gap-1 mt-2">${habitDots}</div>
                    </div>`;
            }

            return `
                <div class="bg-white p-4 sm:p-6 rounded-xl">
                    <div class="flex justify-between items-center mb-4">
                        <button class="calendar-nav-btn px-3 py-1 rounded bg-gray-200" data-direction="-1">&lt; Prev</button>
                        <h2 class="text-xl font-bold">${date.toLocaleString('default', { month: 'long', year: 'numeric' })}</h2>
                        <button class="calendar-nav-btn px-3 py-1 rounded bg-gray-200" data-direction="1">Next &gt;</button>
                    </div>
                    <div class="calendar-grid text-center font-semibold text-gray-600 mb-2">
                        ${['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(d => `<div>${d}</div>`).join('')}
                    </div>
                    <div class="calendar-grid">${dayCells}</div>
                </div>`;
        }

        function renderAnalyticsPage() {
            const periods = [
                { value: '7days', label: '7 Days' }, { value: '30days', label: '30 Days' }, { value: '90days', label: '90 Days' },
                { value: '180days', label: '180 Days' }, { value: '360days', label: '360 Days' }, { value: 'alldays', label: 'All Time' }
            ];

            const renderFilterButtons = (chartType, initialActivePeriod = '7days') => `
                <div class="flex flex-wrap justify-center gap-2 mb-4">
                    ${periods.map(p => `<button class="analytics-filter-btn px-3 py-1 rounded-md text-sm ${p.value === initialActivePeriod ? 'bg-indigo-600 text-white' : 'bg-gray-200'}" data-chart="${chartType}" data-period="${p.value}">${p.label}</button>`).join('')}
                </div>`;

            return `
                <div class="space-y-8">
                    <div class="bg-gray-50 p-6 rounded-xl">
                        <h3 class="text-xl font-semibold mb-4 text-center">Summary Statistics</h3>
                        ${renderFilterButtons('summary', '7days')}
                        <div id="summary-statistics-container" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4"></div>
                    </div>
                    <div class="bg-gray-50 p-6 rounded-xl">
                        <h3 class="text-xl font-semibold mb-4 text-center">Mood & Habit Insights</h3>
                        ${renderFilterButtons('correlation-insights', '7days')}
                        <div id="insights-container">${renderCorrelationInsights('7days')}</div>
                    </div>
                    <div class="grid grid-cols-1 xl:grid-cols-2 gap-8">
                        <div class="bg-white p-6 rounded-xl shadow-md"><h3 class="text-xl font-semibold mb-4 text-center">Mood Trend</h3>${renderFilterButtons('mood')}<div class="relative h-80"><canvas id="mood-trend-chart"></canvas></div></div>
                        <div class="bg-white p-6 rounded-xl shadow-md"><h3 class="text-xl font-semibold mb-4 text-center">Habit Completion</h3>${renderFilterButtons('habit')}<div class="relative h-80"><canvas id="habit-completion-chart"></canvas></div></div>
                        <div class="bg-white p-6 rounded-xl shadow-md"><h3 class="text-xl font-semibold mb-4 text-center">Sleep Duration</h3>${renderFilterButtons('sleep')}<div class="relative h-80"><canvas id="sleep-trend-chart"></canvas></div></div>
                        <div class="bg-white p-6 rounded-xl shadow-md"><h3 class="text-xl font-semibold mb-4 text-center">Hydration Intake</h3>${renderFilterButtons('hydration')}<div class="relative h-80"><canvas id="hydration-analytics-chart"></canvas></div></div>
                        <div class="bg-white p-6 rounded-xl shadow-md"><h3 class="text-xl font-semibold mb-4 text-center">Breathing Sessions</h3>${renderFilterButtons('breath')}<div class="relative h-80"><canvas id="breath-trend-chart"></canvas></div></div>
                    </div>
                </div>`;
        }

        function renderRecommendationsPage() {
            return `
                <div class="bg-gray-50 p-6 rounded-xl">
                    <h2 class="text-2xl font-bold mb-6 text-center">Personalized Recommendations</h2>
                    <div class="flex flex-wrap justify-center gap-2 mb-4" id="recommendations-filter-buttons">
                        ${['today', '3days', '7days', '30days', '90days', '180days', '360days', 'alldays'].map(p => `<button class="recommendation-filter-btn px-3 py-1 rounded-md text-sm ${p === '7days' ? 'bg-indigo-600 text-white' : 'bg-gray-200'}" data-period="${p}">${p.replace('days', ' Days').replace('alldays', 'All Time')}</button>`).join('')}
                    </div>
                    <div id="recommendations-output" class="bg-blue-100 text-blue-800 p-4 rounded-md hidden loading-text"></div>
                    <div id="recommendations-content" class="prose prose-indigo max-w-none bg-white p-4 rounded-md shadow-inner"></div>
                    <div class="flex justify-center mt-6">
                        <button id="generate-recommendations-btn" class="px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 flex items-center gap-2">âœ¨ Regenerate Recommendations</button>
                    </div>
                </div>`;
        }
        
        // --- New Journal Page Renderer ---
        function renderJournalPage() {
            return `
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-gray-50 p-6 rounded-xl">
                        <h2 class="text-2xl font-bold mb-6">AI Journal Assistant</h2>
                        <div class="space-y-4">
                            <p class="text-gray-600">Let the AI generate a journal entry for you based on today's logged data. The entry is designed to sound natural and human. You can edit it before saving.</p>
                            <button id="generate-journal-entry-btn" class="w-full bg-teal-600 text-white font-semibold py-3 rounded-lg hover:bg-teal-700 flex items-center justify-center gap-2">
                                âœ¨ Generate Today's Entry
                            </button>
                            <div id="journal-output-container" class="mt-4">
                                <textarea id="journal-entry-output" class="w-full h-64 p-3 border border-gray-300 rounded-md" placeholder="Your generated journal entry will appear here..."></textarea>
                                 <div id="copy-journal-feedback" class="text-sm text-green-600 h-4 mt-1"></div>
                                <div class="flex justify-end gap-2 mt-2">
                                    <button id="copy-journal-btn" class="px-4 py-2 bg-gray-600 text-white font-semibold rounded-md hover:bg-gray-700 flex items-center gap-2">${SVG_ICONS.copy} <span>Copy</span></button>
                                    <button id="save-journal-entry-btn" class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-md hover:bg-indigo-700">Save Entry</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold mb-6">Past Journal Entries</h2>
                        <div id="journal-history-container" class="space-y-3 max-h-[70vh] overflow-y-auto no-scrollbar">
                           ${renderJournalHistory()}
                        </div>
                    </div>
                </div>`;
        }

        function renderJournalHistory() {
            if (journalEntries.length === 0) return `<p class="text-gray-500 text-center py-4">No saved journal entries yet.</p>`;
            
            const sortedEntries = [...journalEntries].sort((a,b) => new Date(b.date) - new Date(a.date));

            return sortedEntries.map(entry => `
                <div class="p-4 rounded-lg bg-white shadow-sm border border-gray-200">
                    <div class="flex justify-between items-center mb-2">
                        <p class="font-bold text-lg">${toYYYYMMDD(entry.date)}</p>
                        <button class="delete-journal-entry-btn text-gray-400 hover:text-red-600" data-id="${entry.id}">${SVG_ICONS.trash}</button>
                    </div>
                    <div class="prose prose-sm max-w-none text-gray-700 whitespace-pre-wrap">${marked.parse(entry.content)}</div>
                </div>
            `).join('');
        }

        function renderUtilityPage() {
            return `
                <div class="bg-gray-50 p-6 rounded-xl max-w-xl mx-auto shadow-md">
                    <h2 class="text-2xl font-bold mb-6 text-center">Data Management</h2>
                    <div class="space-y-6">
                        <div class="flex flex-col gap-2">
                            <h3 class="text-lg font-semibold text-gray-700">Import Data</h3>
                            <p class="text-sm text-gray-500">Import data from a previously exported JSON file. This will overwrite all current data.</p>
                            <input type="file" id="import-file-input" accept=".json" class="hidden"/>
                            <button id="import-data-btn" class="w-full bg-blue-600 text-white font-semibold py-2 rounded-lg hover:bg-blue-700">Import Data</button>
                            <div id="import-status" class="text-sm mt-2 hidden p-2 rounded-md"></div>
                        </div>
                        <div class="border-t border-gray-200 pt-6 flex flex-col gap-2">
                            <h3 class="text-lg font-semibold text-gray-700">Export Data</h3>
                             <p class="text-sm text-gray-500">Export all your data to a JSON file as a backup or for migration.</p>
                            <button id="export-data-btn" class="w-full bg-green-600 text-white font-semibold py-2 rounded-lg hover:bg-green-700">Export Data</button>
                        </div>
                    </div>
                </div>
            `;
        }

        // --- Data Handling & Business Logic ---
        const parseAndValidateDate = (dateString, fieldName, errorMessages) => {
            if (typeof dateString !== 'string' || !dateString) { errorMessages.push(`Invalid ${fieldName}: must be a non-empty string.`); return null; }
            const date = new Date(dateString);
            if (isNaN(date.getTime())) { errorMessages.push(`Invalid ${fieldName}: "${dateString}" is not a valid date format.`); return null; }
            return date;
        };
        const parseAndValidateNumber = (value, fieldName, errorMessages, min = -Infinity, max = Infinity) => {
            const num = parseFloat(value);
            if (typeof num !== 'number' || isNaN(num)) { errorMessages.push(`Invalid ${fieldName}: must be a number.`); return null; }
            if (num < min || num > max) { errorMessages.push(`Invalid ${fieldName}: value ${num} is out of range (${min}-${max}).`); return null; }
            return num;
        };
        const getHabitStatusOnDate = (habitId, dateKey) => dailyHabitStatuses[habitId]?.[dateKey] || 'pending';
        const isHabitDueOn = (habit, date) => {
            const dateKey = toYYYYMMDD(date);
            if (!dateKey) return false;
            if (habit.isArchived) return false; 
            if ((habit.startDate && dateKey < habit.startDate) || (habit.endDate && dateKey > habit.endDate)) return false;
            if (habit.frequency === 'daily') return true;
            return habit.days.includes(date.toLocaleDateString('en-US', { weekday: 'short' }));
        };
        
        const calculateHabitStreaks = () => {
            habits.forEach(habit => {
                let currentStreak = 0;
                if(habit.isArchived) {
                    habitStreaks[habit.id] = 0;
                    return;
                }

                let checkDate = new Date();

                if (isHabitDueOn(habit, checkDate) && getHabitStatusOnDate(habit.id, toYYYYMMDD(checkDate)) !== 'completed') {
                    checkDate.setDate(checkDate.getDate() - 1);
                }
                
                while (true) {
                    if (isHabitDueOn(habit, checkDate)) {
                        if (getHabitStatusOnDate(habit.id, toYYYYMMDD(checkDate)) === 'completed') {
                            currentStreak++;
                        } else {
                            break;
                        }
                    }
                    
                    checkDate.setDate(checkDate.getDate() - 1);

                    if (new Date() - checkDate > 365 * 2 * 24 * 60 * 60 * 1000) break;
                }
                habitStreaks[habit.id] = currentStreak;
            });
        };

        function renderCorrelationInsights(period = '7days') {
            const { filteredMoodLogs, filteredHabitsWithStatus, filteredSleepLogs } = getFilteredDataByPeriod(period);
            const nonArchivedHabits = habits.filter(h => !h.isArchived);

            if (nonArchivedHabits.length === 0 || filteredMoodLogs.length === 0) {
                return '<p class="text-center text-gray-500">Log more data for correlation insights.</p>';
            }

            const insights = [];

            nonArchivedHabits.forEach(habit => {
                const moodsCompleted = [], moodsNotCompleted = [];
                const habitDataForPeriod = filteredHabitsWithStatus.filter(item => item.habitId === habit.id);

                habitDataForPeriod.forEach(habitStatus => {
                    const moodsForDate = filteredMoodLogs.filter(log => toYYYYMMDD(log.timestamp) === habitStatus.date);
                    if (moodsForDate.length > 0) {
                        const avgMoodForDay = moodsForDate.reduce((a, b) => a + b.moodLevel, 0) / moodsForDate.length;
                        if (habitStatus.status === 'completed') moodsCompleted.push(avgMoodForDay);
                        else if (habitStatus.status === 'skipped') moodsNotCompleted.push(avgMoodForDay);
                    }
                });

                if (moodsCompleted.length > 0) {
                    const avgCompleted = moodsCompleted.reduce((a, b) => a + b, 0) / moodsCompleted.length;
                    let insightText = `When you **${habit.name}**, your average mood is **${avgCompleted.toFixed(1)}**/10.`;
                    
                    if (moodsNotCompleted.length > 0) {
                        const avgNotCompleted = moodsNotCompleted.reduce((a, b) => a + b, 0) / moodsNotCompleted.length;
                        if (Math.abs(avgCompleted - avgNotCompleted) > 0.5) {
                            insightText += ` This is **${Math.abs(avgCompleted - avgNotCompleted).toFixed(1)}** points ${avgCompleted > avgNotCompleted ? 'higher' : 'lower'} than when you skipped it.`;
                        }
                    }
                    insights.push(insightText);
                }
            });

            if (filteredSleepLogs.length > 0 && filteredMoodLogs.length > 0) {
                const moodAfterGoodSleep = [], moodAfterPoorSleep = [];
                filteredSleepLogs.forEach(sleepLog => {
                    const dayAfterSleep = new Date(sleepLog.date);
                    dayAfterSleep.setDate(new Date(sleepLog.date).getDate() + 1);
                    const moodsOnDayAfter = filteredMoodLogs.filter(mood => toYYYYMMDD(mood.timestamp) === toYYYYMMDD(dayAfterSleep));
                    if(moodsOnDayAfter.length > 0){
                        const avgMood = moodsOnDayAfter.reduce((a,b) => a+b.moodLevel, 0) / moodsOnDayAfter.length;
                        if (sleepLog.duration >= 7) moodAfterGoodSleep.push(avgMood);
                        else moodAfterPoorSleep.push(avgMood);
                    }
                });

                if (moodAfterGoodSleep.length > 0) {
                    const avgMoodGoodSleep = moodAfterGoodSleep.reduce((a, b) => a + b, 0) / moodAfterGoodSleep.length;
                    let insightText = `On days following good sleep (7+ hours), your average mood is **${avgMoodGoodSleep.toFixed(1)}**/10.`;
                    
                    if (moodAfterPoorSleep.length > 0) {
                        const avgMoodPoorSleep = moodAfterPoorSleep.reduce((a, b) => a + b, 0) / moodAfterPoorSleep.length;
                        if (Math.abs(avgMoodGoodSleep - avgMoodPoorSleep) > 0.5) {
                            insightText += ` This is **${Math.abs(avgMoodGoodSleep - avgMoodPoorSleep).toFixed(1)}** points ${avgMoodGoodSleep > avgMoodPoorSleep ? 'higher' : 'lower'} than after poor sleep.`;
                        }
                    }
                    insights.push(insightText);
                }
            }

            return insights.length ? `<div class="space-y-3">${insights.map(i => `<div class="p-4 bg-white rounded-lg shadow-sm">${marked.parse(i)}</div>`).join('')}</div>` : '<p class="text-center text-gray-500">Not enough data for correlations in this period.</p>';
        }

        function handleLogMood() {
            const moodLevel = parseInt(document.getElementById('mood-slider').value);
            const notes = document.getElementById('mood-notes').value.trim();
            const tagsInput = document.getElementById('mood-tags').value.trim();
            const tags = tagsInput ? tagsInput.split(',').map(tag => tag.trim()).filter(tag => tag) : [];

            moodLogs.push({ id: generateUniqueId(), moodLevel, notes, tags, timestamp: new Date().toISOString() }); 
            saveData();
            document.getElementById('mood-slider').value = 5;
            document.getElementById('mood-notes').value = '';
            document.getElementById('mood-tags').value = '';
            moodInsightOutput.innerHTML = '';
            moodInsightOutput.classList.add('hidden');
            journalPromptOutput.innerHTML = '';
            journalPromptOutput.classList.add('hidden');
            renderContentForSection('mood-logging-section'); 
            renderContentForSection('dashboard-section');
        }

        function openHabitModal(habit = null) {
            const form = document.getElementById('habit-form');
            form.reset();
            document.getElementById('specific-days-container').classList.remove('expanded');
            habitSuggestionsOutput.innerHTML = ''; 
            habitSuggestionsOutput.classList.add('hidden');
            habitSuggestionsOutput.classList.remove('loading-text'); 
            
            document.getElementById('habit-goal-type').value = '';
            document.getElementById('habit-goal-value').value = '';
            document.getElementById('habit-goal-unit').value = '';

            if (habit) {
                document.getElementById('habit-modal-title').textContent = 'Edit Habit';
                form.querySelector('#habit-id').value = habit.id;
                form.querySelector('#new-habit-name').value = habit.name;
                form.querySelector('#habit-frequency').value = habit.frequency;
                form.querySelector('#habit-start-date').value = habit.startDate || '';
                form.querySelector('#habit-end-date').value = habit.endDate || '';
                form.querySelector('#habit-color-picker').value = habit.color;
                form.querySelector('#habit-reminder-time').value = habit.habitReminderTime || ''; 
                if (habit.frequency === 'specific-days') {
                    document.getElementById('specific-days-container').classList.add('expanded');
                    document.querySelectorAll('#specific-days-container input').forEach(cb => cb.checked = habit.days.includes(cb.value));
                }
                document.getElementById('habit-goal-type').value = habit.goalType || '';
                document.getElementById('habit-goal-value').value = habit.goalValue || '';
                document.getElementById('habit-goal-unit').value = habit.goalUnit || '';

            } else {
                document.getElementById('habit-modal-title').textContent = 'Add New Habit';
                form.querySelector('#habit-color-picker').value = `#${Math.floor(Math.random()*16777215).toString(16).padStart(6, '0')}`;
                form.querySelector('#habit-reminder-time').value = ''; 
            }
            toggleModal(habitModal, true);
        }

        function handleHabitFormSubmit(e) {
            e.preventDefault();
            const habitData = {
                name: e.target.querySelector('#new-habit-name').value.trim(),
                frequency: e.target.querySelector('#habit-frequency').value,
                days: Array.from(e.target.querySelectorAll('#specific-days-container input:checked')).map(cb => cb.value),
                startDate: e.target.querySelector('#habit-start-date').value || null,
                endDate: e.target.querySelector('#habit-end-date').value || null,
                color: e.target.querySelector('#habit-color-picker').value,
                habitReminderTime: e.target.querySelector('#habit-reminder-time').value || null, 
                goalType: e.target.querySelector('#habit-goal-type').value || null,
                goalValue: parseInt(e.target.querySelector('#habit-goal-value').value) || null,
                goalUnit: e.target.querySelector('#habit-goal-unit').value.trim() || null,
            };

            if(!habitData.name) { alert("Habit name cannot be empty."); return; }

            const id = e.target.querySelector('#habit-id').value;
            if (id) {
                const index = habits.findIndex(h => h.id === id);
                if (index !== -1) { habits[index] = { ...habits[index], ...habitData }; }
            } else {
                habits.push({ id: generateUniqueId(), ...habitData, createdAt: new Date().toISOString(), isArchived: false });
            }
            saveData();
            calculateHabitStreaks();
            toggleModal(habitModal, false);
            renderContentForSection('habit-tracking-section'); 
            renderContentForSection('dashboard-section'); 
        }
        
        function deleteHabit(id) {
            showConfirmation('Delete Habit?', 'This will permanently delete the habit and all its history. Are you sure?', () => {
                habits = habits.filter(h => h.id !== id);
                delete dailyHabitStatuses[id]; 
                saveData();
                calculateHabitStreaks();
                renderContentForSection('habit-tracking-section');
                renderContentForSection('dashboard-section');
                renderContentForSection('calendar-section');
                renderContentForSection('analytics-section');
            });
        }

        function archiveHabit(id) {
            const habit = habits.find(h => h.id === id);
            if (habit) {
                const newArchivedState = !habit.isArchived;
                showConfirmation(
                    newArchivedState ? 'Archive Habit?' : 'Unarchive Habit?',
                    newArchivedState ? 'This habit will be hidden from the main view but its data will be preserved.' : 'This habit will be visible again in the main view.',
                    () => {
                        habit.isArchived = newArchivedState;
                        saveData();
                        calculateHabitStreaks();
                        renderContentForSection('habit-tracking-section');
                        renderContentForSection('dashboard-section');
                    }
                );
            }
        }

        function handleHabitStatusUpdate(habitId, status) {
            const todayKey = toYYYYMMDD(new Date());
            if (!dailyHabitStatuses[habitId]) dailyHabitStatuses[habitId] = {};
            
            dailyHabitStatuses[habitId][todayKey] = (dailyHabitStatuses[habitId][todayKey] === status) ? 'pending' : status;
            saveData();
            calculateHabitStreaks();
            
            if (dailyHabitStatuses[habitId][todayKey] === 'completed') {
                const habit = habits.find(h => h.id === habitId);
                if (habit) showHabitNotification(habit.name);
            }
            renderContentForSection('dashboard-section'); 
            // Also re-render the habits page if it's the current view
            if (document.querySelector('.nav-link.active[data-target="habit-tracking-section"]')) {
                 renderContentForSection('habit-tracking-section');
            }
        }
        
        // --- Charting ---
        function renderChart(canvasId, type, period) {
            let chartInstance;
            switch(canvasId) {
                case 'mood-trend-chart': chartInstance = moodChartInstance; break;
                case 'habit-completion-chart': chartInstance = habitChartInstance; break;
                case 'sleep-trend-chart': chartInstance = sleepChartInstance; break;
                case 'hydration-analytics-chart': chartInstance = hydrationChartInstance; break;
                case 'breath-trend-chart': chartInstance = breathChartInstance; break;
            }
            if (chartInstance) chartInstance.destroy();
            
            const canvas = document.getElementById(canvasId);
            if(!canvas) return;
            const ctx = canvas.getContext('2d');
            
            const { labels, datasets } = getChartData(period, type);
            
            const noDataP = canvas.parentElement.querySelector('.chart-no-data');
            if (datasets.every(ds => ds.data.every(d => d === null || d === 0))) {
                if(!noDataP) {
                    const p = document.createElement('p');
                    p.className = 'chart-no-data absolute inset-0 flex items-center justify-center text-gray-500';
                    p.textContent = 'No data for this period.';
                    canvas.parentElement.appendChild(p);
                }
                canvas.style.display = 'none';
                return;
            } else {
                 if(noDataP) noDataP.remove();
                 canvas.style.display = 'block';
            }

            const chartConfig = {
                type: (type === 'mood' || type === 'sleep' || type === 'hydration' || type === 'breath') ? 'line' : 'bar',
                data: { labels, datasets },
                options: { responsive: true, maintainAspectRatio: false }
            };

            if(type === 'mood') { chartConfig.options.scales = { y: { min: 1, max: 10 } }; moodChartInstance = new Chart(ctx, chartConfig); } 
            else if (type === 'habit') { chartConfig.options.scales = { x: { stacked: true }, y: { stacked: true, beginAtZero: true } }; habitChartInstance = new Chart(ctx, chartConfig); } 
            else if (type === 'sleep') { chartConfig.options.scales = { y: { beginAtZero: true, title: { display: true, text: 'Hours' } } }; sleepChartInstance = new Chart(ctx, chartConfig); }
            else if (type === 'hydration') { chartConfig.options.scales = { y: { beginAtZero: true, title: { display: true, text: 'Volume (ml)' } } }; hydrationChartInstance = new Chart(ctx, chartConfig); } 
            else if (type === 'breath') { chartConfig.options.scales = { y: { beginAtZero: true, title: { display: true, text: 'Minutes' } } }; breathChartInstance = new Chart(ctx, chartConfig); }
        }
        
        const renderMoodTrendChart = (period) => renderChart('mood-trend-chart', 'mood', period);
        const renderHabitCompletionChart = (period) => renderChart('habit-completion-chart', 'habit', period);
        const renderSleepTrendChart = (period) => renderChart('sleep-trend-chart', 'sleep', period);
        const renderHydrationTrendChart = (period) => renderChart('hydration-analytics-chart', 'hydration', period);
        const renderBreathTrendChart = (period) => renderChart('breath-trend-chart', 'breath', period);

        function getChartData(period, type) {
            const { labels, dataPoints } = getFilteredDataByPeriod(period, true);

            if(type === 'mood') {
                const data = Object.values(dataPoints).map(dp => dp.mood.count > 0 ? (dp.mood.total / dp.mood.count) : null);
                return { labels, datasets: [{ label: 'Average Mood', data, borderColor: '#4F46E5', backgroundColor: 'rgba(79, 70, 229, 0.1)', fill: true, tension: 0.3, spanGaps: true }] };
            } else if (type === 'habit') {
                const completedData = Object.values(dataPoints).map(dp => dp.habit.completed);
                const skippedData = Object.values(dataPoints).map(dp => dp.habit.skipped);
                return { labels, datasets: [{ label: 'Completed', data: completedData, backgroundColor: '#10B981' }, { label: 'Skipped', data: skippedData, backgroundColor: '#F59E0B' }] };
            } else if (type === 'sleep') {
                const data = Object.values(dataPoints).map(dp => dp.sleep.count > 0 ? (dp.sleep.total / dp.sleep.count) : null);
                return { labels, datasets: [{ label: 'Average Sleep Hours', data, borderColor: '#2563EB', fill: false, tension: 0.3, spanGaps: true }] };
            } else if (type === 'hydration') {
                const totalIntakeData = Object.values(dataPoints).map(dp => dp.hydration.total > 0 ? dp.hydration.total : null);
                const goalData = dailyWaterNeed > 0 ? Array(labels.length).fill(dailyWaterNeed) : [];
                const datasets = [{ label: 'Daily Intake (ml)', data: totalIntakeData, borderColor: DRINK_COLORS['water'], fill: false, tension: 0.3, spanGaps: true }];
                if (goalData.length > 0) datasets.push({ label: 'Daily Goal (ml)', data: goalData, borderColor: '#A5B4FC', borderDash: [5, 5], fill: false, pointRadius: 0 });
                return { labels, datasets };
            } else if (type === 'breath') {
                const data = Object.values(dataPoints).map(dp => dp.breath.count > 0 ? (dp.breath.total / dp.breath.count) : null);
                return { labels, datasets: [{ label: 'Average Session (min)', data, borderColor: '#EF4444', fill: false, tension: 0.3, spanGaps: true }] };
            }
            return { labels: [], datasets: [] };
        }
        
        function checkAndResetHabits() {
            if (hasResetBeenChecked) return;
            hasResetBeenChecked = true;

            const metadata = JSON.parse(localStorage.getItem(LS_METADATA) || '{}');
            const lastResetStr = metadata.lastReset;
            if (!lastResetStr) {
                localStorage.setItem(LS_METADATA, JSON.stringify({ ...metadata, lastReset: new Date().toISOString() }));
                return;
            }
            
            const lastResetDate = new Date(lastResetStr);
            lastResetDate.setHours(0,0,0,0);
            const today = new Date();
            today.setHours(0,0,0,0);
            
            if (lastResetDate.getTime() < today.getTime()) {
                let operations = 0;
                for (let d = new Date(lastResetDate); d < today; d.setDate(d.getDate() + 1)) {
                    const dateKey = toYYYYMMDD(d);
                    habits.filter(h => !h.isArchived).forEach(habit => {
                        if (isHabitDueOn(habit, d) && getHabitStatusOnDate(habit.id, dateKey) === 'pending') {
                            if (!dailyHabitStatuses[habit.id]) dailyHabitStatuses[habit.id] = {};
                            dailyHabitStatuses[habit.id][dateKey] = 'skipped';
                            operations++;
                        }
                    });
                }
                
                if (operations > 0) saveData(); 
                localStorage.setItem(LS_METADATA, JSON.stringify({ ...metadata, lastReset: new Date().toISOString() }));
                console.log(`Habit reset complete. ${operations} habits marked as skipped.`);
            }
        }

        function renderSummaryStatistics(period) {
            const summary = getSummaryStatistics(period);
            const container = document.getElementById('summary-statistics-container');
            if (!container) return;

            container.innerHTML = `
                <div class="bg-white p-4 rounded-lg shadow-sm text-center"><p class="text-sm font-medium text-gray-700">Avg Mood</p><p class="text-3xl font-bold text-indigo-600">${summary.avgMood}</p></div>
                <div class="bg-white p-4 rounded-lg shadow-sm text-center"><p class="text-sm font-medium text-gray-700">Avg Sleep</p><p class="text-3xl font-bold text-green-600">${summary.avgSleepHours} hrs</p></div>
                <div class="bg-white p-4 rounded-lg shadow-sm text-center"><p class="text-sm font-medium text-gray-700">Habit Comp.</p><p class="text-3xl font-bold text-purple-600">${summary.habitCompletionRate}%</p></div>
                <div class="bg-white p-4 rounded-lg shadow-sm text-center"><p class="text-sm font-medium text-gray-700">Avg Hydration</p><p class="text-3xl font-bold text-blue-600">${summary.avgDailyHydration} ml</p></div>
                <div class="bg-white p-4 rounded-lg shadow-sm text-center"><p class="text-sm font-medium text-gray-700">Breath Time</p><p class="text-3xl font-bold text-red-600">${(summary.avgBreathSessionDuration / 60).toFixed(1)} min</p></div>
            `;
        }

        function getFilteredDataByPeriod(period, forChart = false) {
            const now = new Date();
            let startDate = new Date();
            startDate.setHours(0, 0, 0, 0);

            if (period === 'today') { /* no change needed */ } 
            else if (period.endsWith('days')) { startDate.setDate(now.getDate() - (parseInt(period) - 1)); } 
            else if (period === 'alldays') {
                const allTimestamps = [
                    ...moodLogs.map(l => new Date(l.timestamp).getTime()),
                    ...sleepLogs.map(l => new Date(l.date).getTime()),
                    ...breathLogs.map(l => new Date(l.timestamp).getTime()),
                    ...Object.keys(hydrationLogs).map(k => new Date(k).getTime())
                ].filter(t => !isNaN(t));
                if (allTimestamps.length > 0) startDate = new Date(Math.min(...allTimestamps));
            }
            
            const filteredMoodLogs = moodLogs.filter(log => new Date(log.timestamp) >= startDate);
            const filteredSleepLogs = sleepLogs.filter(log => new Date(log.date) >= startDate);
            const filteredBreathLogs = breathLogs.filter(log => new Date(log.timestamp) >= startDate);
            const filteredHydrationLogs = Object.fromEntries(Object.entries(hydrationLogs).filter(([dateKey]) => new Date(dateKey) >= startDate));

            const filteredHabitsWithStatus = [];
            for (let d = new Date(startDate); d <= now; d.setDate(d.getDate() + 1)) {
                const dateKey = toYYYYMMDD(d);
                habits.forEach(habit => {
                    const status = getHabitStatusOnDate(habit.id, dateKey);
                    if (status !== 'pending' || isHabitDueOn(habit, d)) {
                         filteredHabitsWithStatus.push({ habitId: habit.id, date: dateKey, status: status, isArchived: habit.isArchived });
                    }
                });
            }

            if (forChart) {
                const labels = [];
                const dataPoints = {};
                for (let d = new Date(startDate); d <= now; d.setDate(d.getDate() + 1)) {
                    const dateKey = toYYYYMMDD(d);
                    labels.push(d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
                    dataPoints[dateKey] = { mood: { total: 0, count: 0 }, habit: { completed: 0, skipped: 0 }, sleep: { total: 0, count: 0 }, hydration: { total: 0 }, breath: { total: 0, count: 0 }};
                }
                filteredMoodLogs.forEach(log => { const k = toYYYYMMDD(log.timestamp); if(dataPoints[k]) { dataPoints[k].mood.total += log.moodLevel; dataPoints[k].mood.count++; }});
                filteredSleepLogs.forEach(log => { const k = toYYYYMMDD(log.date); if(dataPoints[k]) { dataPoints[k].sleep.total += log.duration; dataPoints[k].sleep.count++; }});
                filteredBreathLogs.forEach(log => { const k = toYYYYMMDD(log.timestamp); if(dataPoints[k]) { dataPoints[k].breath.total += log.elapsedTime / 60; dataPoints[k].breath.count++; }});
                Object.entries(filteredHydrationLogs).forEach(([k, log]) => { if(dataPoints[k]) dataPoints[k].hydration.total = log.totalIntake; });
                filteredHabitsWithStatus.forEach(h => { if(dataPoints[h.date] && !h.isArchived) { if(h.status === 'completed') dataPoints[h.date].habit.completed++; else if(h.status === 'skipped') dataPoints[h.date].habit.skipped++; }});
                return { labels, dataPoints };
            }

            return { filteredMoodLogs, filteredSleepLogs, filteredBreathLogs, filteredHydrationLogs, filteredHabitsWithStatus };
        }

        function getSummaryStatistics(period) {
            const { filteredMoodLogs, filteredSleepLogs, filteredBreathLogs, filteredHydrationLogs, filteredHabitsWithStatus } = getFilteredDataByPeriod(period);

            const avgMood = filteredMoodLogs.length > 0 ? (filteredMoodLogs.reduce((s, l) => s + l.moodLevel, 0) / filteredMoodLogs.length).toFixed(1) : '--';
            const avgSleepHours = filteredSleepLogs.length > 0 ? (filteredSleepLogs.reduce((s, l) => s + l.duration, 0) / filteredSleepLogs.length).toFixed(1) : '--';
            
            const dueHabits = filteredHabitsWithStatus.filter(h => !h.isArchived);
            const completedHabits = dueHabits.filter(h => h.status === 'completed').length;
            const habitCompletionRate = dueHabits.length > 0 ? ((completedHabits / dueHabits.length) * 100).toFixed(0) : '--';

            const hydrationDays = Object.values(filteredHydrationLogs);
            const avgDailyHydration = hydrationDays.length > 0 ? (hydrationDays.reduce((s, l) => s + l.totalIntake, 0) / hydrationDays.length).toFixed(0) : '--';
            const avgBreathSessionDuration = filteredBreathLogs.length > 0 ? (filteredBreathLogs.reduce((s, l) => s + l.elapsedTime, 0) / filteredBreathLogs.length) : 0;

            return { avgMood, avgSleepHours, habitCompletionRate, avgDailyHydration, avgBreathSessionDuration };
        }
        
        async function generateJournalPrompt() {
            const promptContainer = document.getElementById('journal-prompt-container');
            promptContainer.innerHTML = '';
            promptContainer.appendChild(journalPromptOutput);

            journalPromptOutput.textContent = 'Generating prompt...';
            journalPromptOutput.classList.remove('hidden');
            journalPromptOutput.classList.add('loading-text');

            try {
                const prompt = `Generate a single, short (1-2 sentences) reflective journaling prompt focused on well-being, gratitude, or self-discovery.`;
                const promptText = await callGeminiAPI(prompt);
                journalPromptOutput.innerHTML = `<strong>Journal Prompt:</strong> ${promptText}`;
            } catch (error) {
                journalPromptOutput.textContent = 'Could not generate prompt. Please try again.';
            } finally {
                journalPromptOutput.classList.remove('loading-text');
            }
        }

        async function generateMoodInsight() {
            const journalEntry = document.getElementById('mood-notes').value.trim();
            const insightContainer = document.getElementById('mood-insight-container');
            insightContainer.innerHTML = ''; 
            insightContainer.appendChild(moodInsightOutput); 

            if (!journalEntry) {
                moodInsightOutput.textContent = 'Please write a journal entry to get an insight.';
                moodInsightOutput.classList.remove('hidden');
                return;
            }

            moodInsightOutput.textContent = 'Generating insight...';
            moodInsightOutput.className = 'bg-blue-100 text-blue-800 p-3 rounded-md mt-2 loading-text';

            try {
                const prompt = `Analyze the following journal entry and provide a concise, empathetic insight or summary of the sentiment and key themes. Keep it to 1-2 sentences. Journal Entry: "${journalEntry}"`;
                const insightText = await callGeminiAPI(prompt);
                moodInsightOutput.textContent = insightText;
            } catch (error) {
                moodInsightOutput.textContent = 'Error generating insight. Please check your network connection.';
            } finally {
                moodInsightOutput.classList.remove('loading-text');
            }
        }
        
        async function generateHabitSuggestions() {
            habitSuggestionsOutput.innerHTML = 'Generating suggestions...';
            habitSuggestionsOutput.className = 'text-gray-600 text-sm mt-2 italic p-2 rounded-md border border-dashed border-gray-300 loading-text';
            
            try {
                const prompt = `Generate 3 to 5 unique and beneficial daily habits for personal well-being. Return as a JSON object with a key "habits" containing an array of strings. Example: {"habits": ["Read 10 pages", "Meditate for 10 min"]}.`;
                const config = { generationConfig: { responseMimeType: "application/json", responseSchema: { type: "OBJECT", properties: { "habits": { type: "ARRAY", items: { "type": "STRING" } } } } } };
                const jsonText = await callGeminiAPI(prompt, config);
                const parsedJson = JSON.parse(jsonText);
                if (parsedJson.habits && Array.isArray(parsedJson.habits)) {
                    habitSuggestionsOutput.innerHTML = '<strong>Suggestions:</strong> ' + parsedJson.habits.map(h => `<button class="habit-suggestion-item p-1 bg-purple-100 rounded text-purple-800 text-xs hover:bg-purple-200">${h}</button>`).join(' ');
                } else { throw new Error("Invalid JSON structure."); }
            } catch (error) {
                habitSuggestionsOutput.textContent = `Error: Could not generate suggestions.`;
            } finally {
                habitSuggestionsOutput.classList.remove('loading-text');
            }
        }

        async function calculateWaterNeed() {
            const age = document.getElementById('user-age').value, weight = document.getElementById('user-weight').value;
            const outputElement = document.getElementById('water-need-output');
            if (!age || !weight) { outputElement.textContent = 'Please enter valid age and weight.'; outputElement.classList.remove('hidden'); return; }

            outputElement.textContent = 'Calculating...';
            outputElement.className = 'bg-blue-100 text-blue-800 p-3 rounded-md mt-4 loading-text';

            try {
                const prompt = `Calculate the estimated daily water intake in ml for a person with age: ${age} years, weight: ${weight} kg, activity level: ${document.getElementById('activity-level').value}, and climate: ${document.getElementById('climate').value}. Provide only the numerical value in ml in a JSON object. Example: {"waterNeedMl": 2500}`;
                const config = { generationConfig: { responseMimeType: "application/json", responseSchema: { type: "OBJECT", properties: { "waterNeedMl": { "type": "NUMBER" } } } } };
                const jsonText = await callGeminiAPI(prompt, config);
                const parsedJson = JSON.parse(jsonText);
                if (typeof parsedJson.waterNeedMl === 'number') {
                    dailyWaterNeed = parsedJson.waterNeedMl;
                    saveData();
                    outputElement.textContent = `Your estimated daily water need is: ${dailyWaterNeed} ml`;
                    document.getElementById('display-water-need').textContent = `${dailyWaterNeed} ml`;
                    updateHydrationChart(); 
                } else { throw new Error("Invalid number in response."); }
            } catch (error) {
                outputElement.textContent = 'Could not calculate. Please try again.';
            } finally {
                outputElement.classList.remove('loading-text');
            }
        }

        function logHydration(drinkType, quantity) {
            const todayKey = toYYYYMMDD(new Date());
            if (!hydrationLogs[todayKey]) hydrationLogs[todayKey] = { totalIntake: 0, logs: [] };
            
            const waterEquivalent = quantity * (BEVERAGE_WATER_EQUIVALENT[drinkType] || 1.0);
            hydrationLogs[todayKey].totalIntake += waterEquivalent;
            hydrationLogs[todayKey].logs.push({ type: drinkType, quantity, waterEquivalent, timestamp: new Date().toISOString() });
            
            dailyIntake = hydrationLogs[todayKey].totalIntake;
            saveData();
            
            updateHydrationChart();
            document.getElementById('display-current-intake').textContent = `${dailyIntake.toFixed(0)} ml`;
        }

        function updateHydrationChart() {
            const canvas = document.getElementById('hydration-chart');
            if (!canvas) return; 
            const ctx = canvas.getContext('2d');
            if (hydrationChartInstance) hydrationChartInstance.destroy();

            const todayKey = toYYYYMMDD(new Date());
            const currentDayLogs = hydrationLogs[todayKey]?.logs || [];
            
            const aggregatedIntake = currentDayLogs.reduce((acc, log) => {
                acc[log.type] = (acc[log.type] || 0) + log.waterEquivalent;
                return acc;
            }, {});

            let chartLabels = [], chartData = [], chartColors = [];
            Object.entries(aggregatedIntake).forEach(([type, amount]) => {
                chartLabels.push(`${type.replace('-', ' ')} (${amount.toFixed(0)}ml)`);
                chartData.push(amount); 
                chartColors.push(DRINK_COLORS[type]);
            });
            
            const remainingWater = Math.max(0, dailyWaterNeed - dailyIntake);
            if (dailyWaterNeed > 0 && remainingWater > 0) {
                chartLabels.push(`Remaining (${remainingWater.toFixed(0)}ml)`);
                chartData.push(remainingWater);
                chartColors.push(DRINK_COLORS['remaining']);
            }
            
            if (chartData.length === 0) {
                chartLabels.push('No Intake Logged');
                chartData.push(1);
                chartColors.push(DRINK_COLORS['remaining']);
            }

            hydrationChartInstance = new Chart(ctx, {
                type: 'doughnut', data: { labels: chartLabels, datasets: [{ data: chartData, backgroundColor: chartColors, borderColor: '#ffffff', borderWidth: 2 }] },
                options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { position: 'bottom', labels: { boxWidth: 12, padding: 15 } } } }
            });
            
            const percentageTextElement = document.getElementById('hydration-percentage-text');
            if (percentageTextElement) {
                const percentage = dailyWaterNeed > 0 ? Math.min(100, (dailyIntake / dailyWaterNeed) * 100) : 0;
                percentageTextElement.textContent = `${percentage.toFixed(0)}% fulfilled`;
                percentageTextElement.className = `text-lg font-semibold ${percentage >= 100 ? 'text-green-600' : 'text-orange-500'}`;
            }
        }
        
        const scheduleHabitNotifications = () => {
            const now = new Date();
            const currentTime = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
            habits.forEach(habit => {
                if (isHabitDueOn(habit, now) && habit.habitReminderTime === currentTime && getHabitStatusOnDate(habit.id, toYYYYMMDD(now)) === 'pending' && !notificationsSentToday[habit.id]) {
                    if (Notification.permission === "granted") {
                        new Notification("Habit Reminder!", { body: `Time to "${habit.name}"!`, icon: "https://cdn-icons-png.flaticol.com/512/3448/3448338.png" });
                        notificationsSentToday[habit.id] = true; 
                        saveNotificationsSent(); 
                    }
                }
            });
        };

        // --- Sleep Tracking Functions ---
        async function handleLogSleep() {
            const sleepDate = document.getElementById('sleep-date').value, sleepHours = parseInt(document.getElementById('sleep-hours').value), sleepMinutes = parseInt(document.getElementById('sleep-minutes').value);
            const sleepQuality = parseInt(document.getElementById('sleep-quality-slider').value), abnormalities = document.getElementById('sleep-abnormalities').value.trim();
            const loggingStatusEl = document.getElementById('sleep-logging-status');

            if (!sleepDate || isNaN(sleepHours) || isNaN(sleepMinutes) || (sleepHours === 0 && sleepMinutes === 0)) {
                loggingStatusEl.textContent = "Please enter a valid sleep duration."; loggingStatusEl.classList.remove('hidden'); return;
            }

            const newSleepLog = { id: generateUniqueId(), date: sleepDate, duration: parseFloat((sleepHours + sleepMinutes / 60).toFixed(2)), sleepQuality, abnormalities, analysis: null };
            sleepLogs.push(newSleepLog);
            saveData();
            
            document.getElementById('sleep-abnormalities').value = ''; document.getElementById('sleep-hours').value = 8; document.getElementById('sleep-minutes').value = 0;
            document.getElementById('sleep-quality-slider').value = 3; document.getElementById('sleep-quality-value').textContent = 3;
            loggingStatusEl.classList.add('hidden');

            renderContentForSection('sleep-tracking-section');
            if (abnormalities) analyzeAndSaveSleepLog(newSleepLog.id, newSleepLog.duration, abnormalities);
        }

        function deleteSleepLog(id) {
            showConfirmation('Delete Sleep Log?', 'This will be permanent.', () => { sleepLogs = sleepLogs.filter(log => log.id !== id); saveData(); renderContentForSection('sleep-tracking-section'); });
        }

        async function analyzeAndSaveSleepLog(logId, duration, abnormalities) {
            const logIndex = sleepLogs.findIndex(log => log.id === logId);
            if (logIndex === -1) return;

            try {
                const prompt = `Analyze sleep data: ${duration} hours, notes: "${abnormalities}". Provide a concise, helpful insight (1-2 sentences).`;
                const analysisText = await callGeminiAPI(prompt);
                sleepLogs[logIndex].analysis = analysisText;
            } catch (error) {
                sleepLogs[logIndex].analysis = 'Analysis failed.';
            } finally {
                saveData();
                if (document.getElementById('sleep-tracking-section').style.display !== 'none') { renderContentForSection('sleep-tracking-section'); }
            }
        }

        async function analyzeMissingSleepAnalysesOnLoad() {
            const logsToAnalyze = sleepLogs.filter(log => log.abnormalities && !log.analysis);
            if (logsToAnalyze.length > 0) {
                console.log(`Analyzing ${logsToAnalyze.length} sleep logs...`);
                await Promise.all(logsToAnalyze.map(log => analyzeAndSaveSleepLog(log.id, log.duration, log.abnormalities)));
            }
        }

        // --- Breath Helper Functions ---
        function updateBreathingCircle(phase) {
            const circle = document.getElementById('breathing-circle');
            const text = document.getElementById('breathing-text');
            if (!circle || !text) return;

            circle.className = 'breathing-circle-container';
            document.documentElement.style.setProperty('--inhale-duration', `${inhaleDuration}s`);
            document.documentElement.style.setProperty('--hold-duration', `${holdDuration}s`);
            document.documentElement.style.setProperty('--exhale-duration', `${exhaleDuration}s`);

            if(phase === 'inhale') { circle.classList.add('breathing-in'); text.textContent = 'Breathe In'; }
            else if (phase === 'hold') { circle.classList.add('breathing-hold'); text.textContent = 'Hold'; }
            else if (phase === 'exhale') { circle.classList.add('breathing-out'); text.textContent = 'Breathe Out'; }
            else { text.textContent = 'Start'; }
        }

        function breatheCycle() {
            clearTimeout(phaseTimeoutId);
            updateBreathingCircle('inhale');
            phaseTimeoutId = setTimeout(() => {
                updateBreathingCircle('hold');
                phaseTimeoutId = setTimeout(() => {
                    updateBreathingCircle('exhale');
                    phaseTimeoutId = setTimeout(breatheCycle, exhaleDuration * 1000);
                }, holdDuration * 1000);
            }, inhaleDuration * 1000);
        }

        function startBreathing() {
            inhaleDuration = Math.max(1, parseInt(document.getElementById('inhale-duration-input').value) || 4);
            holdDuration = Math.max(0, parseInt(document.getElementById('hold-duration-input').value) || 4);
            exhaleDuration = Math.max(1, parseInt(document.getElementById('exhale-duration-input').value) || 4);
            stopBreathing(false);
            sessionStartTime = Date.now();
            breatheCycle();
        }

        function stopBreathing(logSession = true) {
            clearTimeout(phaseTimeoutId);
            phaseTimeoutId = null;
            updateBreathingCircle('initial');

            if (logSession && sessionStartTime) {
                handleLogBreathingSession((Date.now() - sessionStartTime) / 1000);
            }
            sessionStartTime = null;
        }

        function handleLogBreathingSession(elapsedTime) {
            if (elapsedTime <= 1) return; // Don't log very short sessions
            const newLog = { id: generateUniqueId(), timestamp: new Date().toISOString(), inhaleDuration, holdDuration, exhaleDuration, elapsedTime };
            breathLogs.push(newLog);
            saveData();
            renderContentForSection('breath-helper-section');
        }

        function deleteBreathLog(id) {
            showConfirmation('Delete Breathing Log?', 'This will be permanent.', () => { breathLogs = breathLogs.filter(log => log.id !== id); saveData(); renderContentForSection('breath-helper-section'); });
        }

        async function generatePersonalizedRecommendations(period = '7days') {
            const output = document.getElementById('recommendations-output');
            const content = document.getElementById('recommendations-content');
            output.textContent = 'Generating recommendations...';
            output.className = 'bg-blue-100 text-blue-800 p-4 rounded-md loading-text';
            content.innerHTML = '';
            document.querySelectorAll('.recommendation-filter-btn').forEach(btn => btn.className = `recommendation-filter-btn px-3 py-1 rounded-md text-sm ${btn.dataset.period === period ? 'bg-indigo-600 text-white' : 'bg-gray-200'}`);

            const { filteredMoodLogs, filteredSleepLogs, filteredHabitsWithStatus } = getFilteredDataByPeriod(period);
            const summary = getSummaryStatistics(period);
            
            const habitCompletionSummary = habits.filter(h => !h.isArchived).map(h => {
                const due = filteredHabitsWithStatus.filter(s => s.habitId === h.id && !s.isArchived).length;
                const completed = filteredHabitsWithStatus.filter(s => s.habitId === h.id && s.status === 'completed').length;
                return `${h.name}: ${due > 0 ? ((completed/due)*100).toFixed(0) : 'N/A'}% completion`;
            }).join(', ');
            
            const prompt = `Based on this user data for the last ${period}, provide personalized, actionable recommendations. Format as a Markdown list. Data: Avg Mood=${summary.avgMood}/10, Avg Sleep=${summary.avgSleepHours}hrs, Habit Completion=[${habitCompletionSummary || 'none'}], Notes: "${filteredMoodLogs.map(l=>l.notes).filter(Boolean).join('. ')}"`;

            try {
                const recommendations = await callGeminiAPI(prompt);
                content.innerHTML = marked.parse(recommendations);
                output.classList.add('hidden');
            } catch (error) {
                content.innerHTML = '<p>Could not generate recommendations. Please try again.</p>';
            } finally {
                output.classList.remove('loading-text');
            }
        }
        
        async function generateJournalEntry() {
            const outputArea = document.getElementById('journal-entry-output');
            outputArea.value = 'Gathering today\'s data and writing your journal entry...';
            outputArea.classList.add('loading-text');
            
            const todayKey = toYYYYMMDD(new Date());
            const todaysMoods = moodLogs.filter(log => toYYYYMMDD(log.timestamp) === todayKey);
            const todaysSleep = sleepLogs.find(log => toYYYYMMDD(log.date) === todayKey);
            const todaysHabits = habits.map(habit => ({
                name: habit.name,
                status: getHabitStatusOnDate(habit.id, todayKey)
            })).filter(h => h.status !== 'pending');

            let promptContext = "Today's data:\n";
            if (todaysMoods.length > 0) {
                const avgMood = todaysMoods.reduce((sum, log) => sum + log.moodLevel, 0) / todaysMoods.length;
                promptContext += `- Overall mood was about a ${avgMood.toFixed(1)}/10.`;
                const notes = todaysMoods.map(m => m.notes).filter(Boolean).join('; ');
                if(notes) promptContext += ` Thoughts included: "${notes}".\n`;
            } else {
                 promptContext += "- No mood logged today.\n";
            }

            if(todaysSleep) {
                promptContext += `- Slept for ${todaysSleep.duration} hours with a quality of ${todaysSleep.sleepQuality}/5.\n`;
            } else {
                promptContext += "- No sleep logged for last night.\n";
            }

            if(todaysHabits.length > 0) {
                const completed = todaysHabits.filter(h => h.status === 'completed').map(h => h.name).join(', ') || 'none';
                const skipped = todaysHabits.filter(h => h.status === 'skipped').map(h => h.name).join(', ') || 'none';
                promptContext += `- Habits completed: ${completed}.\n- Habits skipped: ${skipped}.\n`;
            } else {
                 promptContext += "- No habits tracked today.\n";
            }
            
            const prompt = `You are a person writing a private journal entry about your day. Your tone should be reflective, personal, and completely natural. Do NOT sound like an AI, a report, or an assistant. Use "I" statements. Be concise. Write a short paragraph based on the following data points, weaving them into a narrative. Do not just list the data. Do not mention "data points" or "habits". If data is missing for a category, just ignore it and write about the other things.

${promptContext}

Based on this, write a short, reflective journal entry for me.`;

            try {
                const entry = await callGeminiAPI(prompt);
                outputArea.value = entry;
            } catch (error) {
                outputArea.value = "Sorry, I couldn't generate a journal entry right now. Please try again later.";
            } finally {
                outputArea.classList.remove('loading-text');
            }
        }

        function saveJournalEntry() {
            const content = document.getElementById('journal-entry-output').value.trim();
            if (!content) return;

            const today = new Date();
            const existingEntryIndex = journalEntries.findIndex(e => toYYYYMMDD(e.date) === toYYYYMMDD(today));

            const newEntry = {
                id: generateUniqueId(),
                date: today.toISOString(),
                content: content
            };

            if (existingEntryIndex > -1) {
                showConfirmation("Overwrite Entry?", "You already have a journal entry for today. Do you want to overwrite it?", () => {
                    journalEntries[existingEntryIndex] = newEntry;
                    saveData();
                    document.getElementById('journal-history-container').innerHTML = renderJournalHistory();
                });
            } else {
                journalEntries.push(newEntry);
                saveData();
                document.getElementById('journal-history-container').innerHTML = renderJournalHistory();
            }
        }
        
        function deleteJournalEntry(id) {
            showConfirmation("Delete Journal Entry?", "This action cannot be undone.", () => {
                journalEntries = journalEntries.filter(entry => entry.id !== id);
                saveData();
                document.getElementById('journal-history-container').innerHTML = renderJournalHistory();
            });
        }
        
        function copyJournalToClipboard() {
            const outputArea = document.getElementById('journal-entry-output');
            const feedbackEl = document.getElementById('copy-journal-feedback');
            if (navigator.clipboard) {
                navigator.clipboard.writeText(outputArea.value).then(() => {
                    feedbackEl.textContent = 'Copied to clipboard!';
                    setTimeout(() => feedbackEl.textContent = '', 2000);
                });
            } else {
                 // Fallback for older browsers
                outputArea.select();
                document.execCommand('copy');
                feedbackEl.textContent = 'Copied to clipboard! (fallback)';
                setTimeout(() => feedbackEl.textContent = '', 2000);
            }
        }

        function exportDataToJson() {
            const dataToExport = {
                moodLogs, habits, dailyHabitStatuses, sleepLogs, breathLogs, hydrationLogs, journalEntries,
                metadata: JSON.parse(localStorage.getItem(LS_METADATA) || '{}')
            };
            const blob = new Blob([JSON.stringify(dataToExport, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `zenith_tracker_data_${toYYYYMMDD(new Date())}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function importDataFromJson(event) {
            const file = event.target.files[0];
            const importStatusEl = document.getElementById('import-status');
            importStatusEl.className = 'text-sm mt-2 p-2 rounded-md loading-text text-gray-700';
            importStatusEl.textContent = 'Reading file...';

            if (!file) { importStatusEl.textContent = 'No file selected.'; return; }

            const reader = new FileReader();
            reader.onload = (e) => {
                let importedData;
                try { importedData = JSON.parse(e.target.result); } 
                catch (error) { importStatusEl.className = 'text-sm mt-2 p-2 rounded-md bg-red-100 text-red-700'; importStatusEl.textContent = `Error: Invalid JSON file.`; return; }
                
                showConfirmation('Import Data?', 'This will overwrite all existing data.', () => {
                    const validatedHabits = (importedData.habits || []).map(h => ({ ...h, days: Array.isArray(h.days) ? h.days : [] })).filter(Boolean);
                    
                    moodLogs = importedData.moodLogs || [];
                    habits = validatedHabits;
                    dailyHabitStatuses = importedData.dailyHabitStatuses || {};
                    sleepLogs = importedData.sleepLogs || [];
                    breathLogs = importedData.breathLogs || [];
                    hydrationLogs = importedData.hydrationLogs || {};
                    journalEntries = importedData.journalEntries || [];
                    dailyWaterNeed = importedData.metadata?.dailyWaterNeed || 0;
                    
                    saveData();
                    initializeApp(true);
                    showSection(document.querySelector('.nav-link.active').dataset.target);
                    importStatusEl.className = 'text-sm mt-2 p-2 rounded-md bg-green-100 text-green-700';
                    importStatusEl.textContent = 'Data imported successfully!';
                }, () => {
                     importStatusEl.className = 'text-sm mt-2 p-2 rounded-md bg-yellow-100 text-yellow-700';
                     importStatusEl.textContent = 'Import cancelled.';
                }, 'Import & Overwrite', 'bg-blue-600');
            };
            reader.readAsText(file);
        }

        // --- Initialization & Listeners ---
        function attachGlobalListeners() {
            document.querySelectorAll('.nav-link').forEach(l => l.addEventListener('click', () => showSection(l.dataset.target)));
            document.getElementById('close-habit-modal').addEventListener('click', () => toggleModal(habitModal, false));
            document.getElementById('cancel-habit-modal').addEventListener('click', () => toggleModal(habitModal, false));
            document.getElementById('habit-form').addEventListener('submit', handleHabitFormSubmit);
            document.getElementById('habit-frequency').addEventListener('change', (e) => document.getElementById('specific-days-container').classList.toggle('expanded', e.target.value === 'specific-days'));
            
            document.getElementById('confirm-modal-ok').addEventListener('click', () => { if (confirmCallback) { confirmCallback(); confirmCallback = null; } toggleModal(confirmModal, false); });
            document.getElementById('confirm-modal-cancel').addEventListener('click', () => { if (cancelCallback) { cancelCallback(); cancelCallback = null; } toggleModal(confirmModal, false); });

            appContainer.addEventListener('click', (e) => {
                const target = e.target.closest('button');
                if(!target) return;
                
                const handlers = {
                    'log-mood-btn': handleLogMood, 'get-mood-insight-btn': generateMoodInsight,
                    'get-journal-prompt-btn': generateJournalPrompt, 'add-new-habit-btn': () => openHabitModal(),
                    'suggest-habits-btn': generateHabitSuggestions, 'calculate-water-need-btn': calculateWaterNeed,
                    'log-sleep-btn': handleLogSleep, 'start-breathing-btn': startBreathing,
                    'stop-breathing-btn': () => stopBreathing(true),
                    'generate-recommendations-btn': () => generatePersonalizedRecommendations(document.querySelector('.recommendation-filter-btn.bg-indigo-600')?.dataset.period || '7days'),
                    'export-data-btn': exportDataToJson,
                    'import-data-btn': () => document.getElementById('import-file-input')?.click(),
                    'generate-journal-entry-btn': generateJournalEntry,
                    'save-journal-entry-btn': saveJournalEntry,
                    'copy-journal-btn': copyJournalToClipboard
                };
                if(handlers[target.id]) handlers[target.id]();

                if (target.classList.contains('habit-suggestion-item')) { document.getElementById('new-habit-name').value = target.textContent; } 
                else if(target.classList.contains('habit-status-btn')) handleHabitStatusUpdate(target.dataset.habitId, target.dataset.status);
                else if(target.classList.contains('delete-mood-btn')) deleteHabit(target.dataset.id);
                else if(target.classList.contains('edit-habit-btn')) openHabitModal(habits.find(h => h.id === target.dataset.id));
                else if(target.classList.contains('archive-toggle-habit-btn')) archiveHabit(target.dataset.id);
                else if(target.classList.contains('delete-habit-btn')) deleteHabit(target.dataset.id);
                else if(target.classList.contains('calendar-nav-btn')) { currentCalendarDate.setMonth(currentCalendarDate.getMonth() + parseInt(target.dataset.direction)); renderContentForSection('calendar-section'); }
                else if(target.classList.contains('analytics-filter-btn')) {
                    target.parentElement.querySelectorAll('.analytics-filter-btn').forEach(b => b.className = b.className.replace('bg-indigo-600 text-white', 'bg-gray-200'));
                    target.className = target.className.replace('bg-gray-200', 'bg-indigo-600 text-white');
                    const { chart, period } = target.dataset;
                    if(chart === 'summary') { renderSummaryStatistics(period); document.querySelector('#insights-container').innerHTML = renderCorrelationInsights(period); }
                    else if(chart === 'correlation-insights') { document.querySelector('#insights-container').innerHTML = renderCorrelationInsights(period); }
                    else { renderChart(`${chart}-trend-chart` || `${chart}-analytics-chart`, chart, period); }
                } else if (target.classList.contains('log-drink-btn')) { 
                    const qty = parseInt(document.getElementById(`log-${target.dataset.drinkType}-qty`).value);
                    if (!isNaN(qty) && qty > 0) logHydration(target.dataset.drinkType, qty);
                } else if (target.classList.contains('delete-sleep-log-btn')) deleteSleepLog(target.dataset.id);
                else if (target.classList.contains('delete-breath-log-btn')) deleteBreathLog(target.dataset.id);
                else if (target.classList.contains('delete-journal-entry-btn')) deleteJournalEntry(target.dataset.id);
                else if (target.classList.contains('recommendation-filter-btn')) generatePersonalizedRecommendations(target.dataset.period);
            });

            appContainer.addEventListener('input', e => {
                if (e.target.id === 'mood-slider') { document.getElementById('mood-value').textContent = e.target.value; document.getElementById('mood-emoji').textContent = MOOD_EMOJIS[e.target.value - 1]; }
                else if (e.target.id === 'sleep-quality-slider') { document.getElementById('sleep-quality-value').textContent = e.target.value; }
            });

            appContainer.addEventListener('change', e => {
                const target = e.target;
                if (target.id === 'toggle-archived-habits') {
                    localStorage.setItem('showArchivedHabits', target.checked);
                    renderContentForSection('habit-tracking-section');
                } else if (target.id === 'import-file-input' && target.files.length > 0) {
                    importDataFromJson(e);
                }
            });
        }
        
        async function initializeApp(isReload = false) {
            loadData();
            loadNotificationsSent(); 
            checkAndResetHabits();
            calculateHabitStreaks();

            userInfo.textContent = `ID: Local User`;
            hasInitialDataLoaded = true;
            
            if (!isReload) {
                const initialSection = document.querySelector('.nav-link.active')?.dataset.target || 'dashboard-section';
                showSection(initialSection);
            }
            
            appContainer.classList.remove('opacity-0');
            console.log("App initialized/reloaded successfully.");

            if (Notification.permission === 'default') requestNotificationPermission();
            await analyzeMissingSleepAnalysesOnLoad(); 
            setInterval(scheduleHabitNotifications, 60000);
        }

        const requestNotificationPermission = () => { if ("Notification" in window) Notification.requestPermission(); };
        const showHabitNotification = (name) => { if (Notification.permission === "granted") new Notification("Habit Completed!", { body: `Great job on "${name}"!`, icon: "https://cdn-icons-png.flaticol.com/512/3448/3448338.png" }); };
        
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelector('#specific-days-container div').innerHTML = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(day => `
                <label class="inline-flex items-center p-2 rounded-lg bg-gray-100 cursor-pointer has-[:checked]:bg-indigo-200"><input type="checkbox" class="sr-only" value="${day}"><span class="ml-2">${day}</span></label>`).join('');
            
            attachGlobalListeners();
            initializeApp(); 
        });
    </script>
</body>
</html>
